---
title: "Correlation of PM concentrations and SARS-CoV-2 infection"
always_allow_html: true
editor_options:
  chunk_output_type: console
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Set up working environment and defaults --------------------------------------
library(envimaR)
if(Sys.info()[["nodename"]] == "PC19616"){
  source("~/plygrnd/CovidAirPolution/CovidAirPolution/src/functions/000_setup.R")
} else {
  source("~/project/cov/CovidAirPolution/src/functions/000_setup.R")  
}
compile_data = FALSE

start_date = as.POSIXct("2020-02-15")
end_date = as.POSIXct("2020-04-01")
pm = "PM10"

Sys.setlocale("LC_TIME", "English") 

# Load Germany -----------------------------------------------------------------
if(pm == "PM2.5"){
  savefile = "germany_025.RDS"
} else {
  savefile = "germany_100.RDS"
}
if(compile_data){
  germany = compileDataDE(start_date = start_date, end_date = end_date,
                          pm = pm)
  saveRDS(germany, file.path(envrmt$path_tmp, savefile))
} else {
  germany = readRDS(file.path(envrmt$path_tmp, savefile))
}
```


# Figure 1

## Figure 1a

a, Geographic distribution of total confirmed SARS-CoV-2 infections in Germany on April 1st 2020.
```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = TRUE}
background_map = st_transform(ne_countries(scale = "large", continent = "europe", returnclass = "sf"),
                              crs = "+init=epsg:32632")
layer = st_transform(germany$de_nuts3_map, crs = "+init=epsg:32632")

figure_1a = ggplot(data = background_map) +
  geom_sf() + 
  geom_sf(data = layer, aes(fill = cases)) +
  scale_fill_viridis_c(trans = "log10") +
  theme(legend.position="bottom") +
  labs(fill = "Infections (01.04.2020)") +
  coord_sf(xlim = c((st_bbox(layer)["xmin"] - 10000), 
                    (st_bbox(layer)["xmax"] + 10000)), 
           ylim = c((st_bbox(layer)["ymin"] - 25000),
                    (st_bbox(layer)["ymax"] + 10000)), expand = FALSE) + 
  annotation_scale(location = "br", width_hint = 0.4) +
  annotation_north_arrow(location = "tl", which_north = "true", 
                         pad_x = unit(0.0, "in"), pad_y = unit(0.1, "in"),
                         style = north_arrow_fancy_orienteering)

# ggsave(file.path(envrmt$path_figures, "figure_1a.png"), plot = figure_1a,
#        dpi = 600)
# 
# print(figure_1a)
```


## Figure 1b

b, Raw data on PM2.5 has been provided by the German environmental protection agency (UBN) and WAQI. ...

Data on total daily COVID-19 cases and deaths has been provided by the Robert-Koch-Institut. For some analysis, the data has been smoothed using a gaussian loess function with span 0.3 to reduce variation due to delayed reporting over the weekend and especcially on Sunday and Monday. The daily number of new infections has been computed from the daily variations of the total confirmed numbers.

The following figure shows the countrywide average of daily PM2.5 and smoothed COVID-19 new infections. Black vertical dotted lines represent the start of the contact restrictions (March 14th) and shut down (March 17th).
```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
de_avg = germany$de_avg
figure_1b = ggplot() + 
  geom_line(data = de_avg, aes(x = date, y = pm_mean, color = "Daily mean PM10")) +
  geom_point(data = de_avg, aes(x = date, y = pm_mean, color = "Daily mean PM10")) + 
  geom_line(data = de_avg, aes(x = date, y = new_cases, color = "Daily new cases")) +
  geom_point(data = de_avg, aes(x = date, y = new_cases, color = "Daily new cases")) + 
  geom_line(data = de_avg, aes(x = date, y = new_cases_detr, color = "Daily new cases, detrended"), linetype = "twodash") +
  geom_vline(xintercept = as.POSIXct("2020-03-14"), linetype="dotted", color = "black") +
  geom_vline(xintercept = as.POSIXct("2020-03-17"), linetype="dotted", color = "black") +
  geom_text(aes(x = as.POSIXct("2020-03-14"), label="Start of contact restrictions \n", y=35), colour="black", angle=90) +
  geom_text(aes(x = as.POSIXct("2020-03-17"), label="Start of shut down \n", y=35), colour="black", angle=90) +
  labs(x = "Date and day of week", y = NULL) +
  theme_bw() + 
  scale_x_datetime(date_labels = "%d.%m, %a", date_breaks = "1 day") + 
  scale_color_manual(values=c("blue", "red", "red")) +
  theme(legend.position = c(0.2, 0.9), axis.text.x = element_text(angle=90, hjust=0.95, vjust=0.2), 
        legend.title = element_blank(), panel.background = element_blank(),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# ggsave(file.path(envrmt$path_figures, "figure_1b.png"), plot = figure_1b,
#        dpi = 600)
# 
# print(figure_1b)
```


## Figure 1 combined

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
figure_1 = plot_grid(figure_1a, figure_1b, labels = "auto")
ggsave(file.path(envrmt$path_figures, "figure_1.png"), plot = figure_1, dpi = 300)
```


# Figure 2

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
de_clstr = germany$de_clstr$clstr
de_model_lag = compileLaggedGLM(de_clstr)
de_model_geo = compileLaggedGLMGeo(de_model_lag, germany$de_nuts3_map)
```


## Figure 2a

Dependence of individual COVID-19 time series and lagged PM10 concentrations.

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
figure_2a = ggplot(data = de_model_lag, aes(x = as.factor(lag), y = t)) + 
  geom_boxplot() + 
  theme_bw() +
  geom_hline(yintercept = c(-2, 2), linetype="dashed", color = "black") + 
  labs(x = "Time lag PM10 (days)", y = "t-value of the partial coefficient") + 
  theme(panel.background = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

# ggsave(file.path(envrmt$path_figures, "figure_2a.png"), plot = figure_2a,
#        dpi = 600)
# 
# print(figure_2a)
```


# Figure 2b

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
# ggplot(data = de_model_geo$test_geo_lag) +
#   geom_line(aes(x = lag, y = rsq, color = "R squared")) +
#   geom_point(aes(x = lag, y = rsq, color = "R squared")) +
#   theme_bw() +
#   scale_x_continuous(breaks = seq(-15, 0, 1), minor_breaks = seq(-15, 0, 1)) +
#   labs(title = paste("R squared values of lagged ", pm,
#                      " concentrations based on latitude, longitude and area",
#                      x = "Time lag PM [days]"), y = "R squared",
#        color = "R squared")


figure_2b = ggplot(data = de_model_geo$test_geo_lag) + 
  geom_line(aes(x = lag, y = centroid_lat_t, color = "Latitude")) +
  geom_point(aes(x = lag, y = centroid_lat_t, color = "Latitude")) +
  geom_line(aes(x = lag, y = centroid_lon_t, color = "Longitude")) +
  geom_point(aes(x = lag, y = centroid_lon_t, color = "Longitude")) +
  geom_line(aes(x = lag, y = area_t, color = "Log10(area)")) +
  geom_point(aes(x = lag, y = area_t, color = "Log10(area)")) +
  scale_x_continuous(breaks = seq(-15, 0, 1), minor_breaks = seq(-15, 0, 1)) +
  theme_bw() + 
  geom_hline(yintercept = c(-2, 2), linetype="dashed", color = "black") + 
  labs(x = "Time lag PM10 (days)", y = "t-value of the partial coefficient", 
       color = "") + 
  theme(legend.position = c(0.8, 0.8), panel.background = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())


# ggsave(file.path(envrmt$path_figures, "figure_2b.png"), plot = figure_2b,
#        dpi = 600)
# 
# print(figure_2b)
```

## Figure 2c 

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
figure_2c = ggplot() + 
  geom_point(data = de_model_geo$test_geo[de_model_geo$test_geo$lag <= -10, ], 
             aes(x = centroid_lat, y = t, fill = as.factor(lag), 
                 shape = as.factor(lag), size = as.factor(lag))) +
  scale_shape_manual(values = c(22, 23, 21, 24, 25)) +
  scale_fill_manual(values = c('grey', 'grey','red', 'grey', 'grey')) +
  scale_size_manual(values = c(1.5, 1.5, 3, 1.5, 1.5)) + 
  geom_smooth(data = de_model_geo$test_geo[de_model_geo$test_geo$lag == -12, ], 
              aes(x = centroid_lat, y = t, ), method = "lm", color = "red")+
  theme_bw() + 
  geom_hline(yintercept = c(-2, 2), linetype="dashed", color = "black") + 
  scale_x_continuous(breaks = seq(47, 55, 1)) + 
  scale_y_continuous(breaks = seq(-10, 20, 2)) +
  labs(x = "Latitude (degrees)", y = "t-value of the partial coefficient", 
       fill = "", shape = "", size = "") + 
  theme(legend.position = c(0.65, 0.08), legend.direction="horizontal", 
        panel.background = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())
 

# ggsave(file.path(envrmt$path_figures, "figure_2c.png"), plot = figure_2c,
#        dpi = 600)
# 
# print(figure_2c)

```


## Figure 2d 

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
figure_2d = ggplot() + 
  geom_point(data = de_model_geo$test_geo[de_model_geo$test_geo$lag >= -8 &
                                            de_model_geo$test_geo$lag <= -3, ], 
             aes(x = centroid_lat, y = t, fill = as.factor(lag), 
                 shape = as.factor(lag), size = as.factor(lag))) +
  scale_shape_manual(values = c(22, 23, 21, 24, 25, 21)) +
  scale_fill_manual(values = c('grey', 'grey','red', 'grey', 'grey', "blue")) +
  scale_size_manual(values = c(1.5, 1.5, 3, 1.5, 1.5, 3)) + 
  geom_smooth(data = de_model_geo$test_geo[de_model_geo$test_geo$lag == -6, ], 
              aes(x = centroid_lat, y = t, ), method = "lm", color = "red")+
  theme_bw() + 
  geom_hline(yintercept = c(-2, 2), linetype="dashed", color = "black") + 
  scale_x_continuous(breaks = seq(47, 55, 1)) + 
  scale_y_continuous(breaks = seq(-10, 20, 2)) +
  labs(x = "Latitude (degrees)", y = "t-value of the partial coefficient", 
       fill = "", shape = "", size = "") + 
  theme(legend.position = c(0.3, 0.09), legend.direction="horizontal", 
        panel.background = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())


# ggsave(file.path(envrmt$path_figures, "figure_2d.png"), plot = figure_2d,
#        dpi = 600)
# 
# print(figure_2c)

```


## Figure 2 combined

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
figure_2 = plot_grid(figure_2a, figure_2b, figure_2c, figure_2d, labels = "auto")
ggsave(file.path(envrmt$path_figures, "figure_2.png"), plot = figure_2, dpi = 300)
```



```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}

ggplot(data = de_model_geo$test_geo[de_model_geo$test_geo$lag <= -10,]) + 
  geom_point(aes(x = centroid_lat, y = t, color = as.factor(lag))) +
  theme_bw() + 
  geom_hline(yintercept = c(-2, 2), linetype="dashed", color = "black") + 
  scale_x_continuous(breaks = seq(47, 55, 1)) + 
  scale_y_continuous(breaks = seq(-10, 20, 2)) +
  labs(title = paste("t-values of lagged ", pm, " concentrations for latitude"),x = "Latitude [degrees]", y = "t-value of the partial coefficient for PM (glm model)", color = "Lag of PM")

ggplot(data = de_model_geo$test_geo[de_model_geo$test_geo$lag >= -7 & de_model_geo$test_geo$lag <= -4,]) + 
  geom_point(aes(x = centroid_lat, y = t, color = as.factor(lag))) +
  theme_bw() + 
  geom_hline(yintercept = c(-2, 2), linetype="dashed", color = "black") + 
  scale_x_continuous(breaks = seq(47, 55, 1)) + 
  scale_y_continuous(breaks = seq(-10, 20, 2)) +
  labs(title = paste("t-values of lagged ", pm, " concentrations for latitude"),x = "Latitude [degrees]", y = "t-value of the partial coefficient for PM (glm model)", color = "Lag of PM")
```

Hier mal ein Versuch, die "Italien-Grafik" aus dem  etwas nachzubauen. Die Signifikanz ist bei PM10 für längere Zeitintervalle gegeben, für PM2.5 praktisch nicht (Setti, L. et al. The Potential role of Particulate Matter in the Spreading of COVID-19 in Northern Italy: First Evidence-based Research Hypotheses. medRxiv, https://www.medrxiv.org/content/10.1101/2020.04.11.20061713v1 (2020).)

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
# 10, 12

test = germany$de_clstr$clstr[germany$de_clstr$clstr$date < as.POSIXct("2020-03-17"),] %>%
  group_by(nuts3Code) %>%
  summarize(n_days = n(),
            pm_gt_10 = sum(pm_mean > 10),
            pm_gt_10_rel = pm_gt_10 / n_days)
test_merge = merge(test, germany$de_clstr$clstr[germany$de_clstr$clstr$date == as.POSIXct("2020-04-01"),])
test_merge = merge(test_merge, st_set_geometry(germany$de_nuts3_map, NULL)[, c("nuts3Code", "area")])
test_merge$ratio = as.numeric(test_merge$cases/test_merge$area)

ggplot(data = test_merge, aes(x = pm_gt_10, y = ratio)) + 
  geom_point() +
  geom_smooth(method = "glm") +
  theme_bw() + 
  scale_y_log10() +
  labs(title = paste("COVID-19 infections per province area (01.04.) and days exceeding" , pm, " > 10 from 15.2. to 17.03."))
```

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = TRUE}
model = glm(test_merge$ratio ~ test_merge$pm_gt_10, family = quasipoisson)
summary(model)
```



```{r, eval = FALSE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
# Wavelet coherence analysis

## Wavelet coherence analysis on countrywide average
de_avg = germany$de_avg
wc = compileWC(de_avg)

wc.image(wc, which.image = "wc",
         n.levels = 250, color.key = "interval",
         siglvl.contour = 0.1, siglvl.arrow = 0.1,
         legend.params = list(lab = "cross-wavelet power levels"), show.date = TRUE,
         spec.period.axis = list(at = seq(15)),
         main = paste("Wavelet coherence Germany, ", pm, " x detrended daily COVID-19 cases"))

# wc.sel.phases(wc, sel.period = 4, siglvl = 1, show.date = TRUE)
```



```{r, eval = FALSE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
## Wavelet coherence analysis on cluster averages
de_clstr = germany$de_clstr
for(c in unique(de_clstr$clstr_avg_detr$cluster_pm)){
  tmp = de_clstr$clstr_avg_detr[de_clstr$clstr_avg_detr$cluster_pm == c,]
  wc = compileWC(tmp)
  
  wc.image(wc, which.image = "wc",
           n.levels = 250, color.key = "interval",
           siglvl.contour = 0.1, siglvl.arrow = 0.1,
           legend.params = list(lab = "cross-wavelet power levels"), show.date = TRUE,
           spec.period.axis = list(at = seq(15)),
           main = paste("Germany, ", pm, " x detrended daily COVID-19 cases, cluster ", c))
  
  # wc.sel.phases(wc, sel.period = 4, siglvl = 1, show.date = TRUE)
}
```

