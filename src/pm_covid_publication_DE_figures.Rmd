---
title: "Correlation of PM concentrations and SARS-CoV-2 infection"
always_allow_html: true
editor_options:
  chunk_output_type: console
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Set up working environment and defaults --------------------------------------
library(envimaR)
if(Sys.info()[["nodename"]] == "PC19616"){
  source("~/plygrnd/CovidAirPolution/CovidAirPolution/src/functions/000_setup.R")
} else {
  source("~/project/cov/CovidAirPolution/src/functions/000_setup.R")  
}
compile_data = FALSE

start_date = as.POSIXct("2020-02-15")
end_date = as.POSIXct("2020-04-01")
pm = "PM10"

Sys.setlocale("LC_TIME", "English") 

# Load Germany -----------------------------------------------------------------
if(pm == "PM2.5"){
  savefile = "germany_025.RDS"
} else {
  savefile = "germany_100.RDS"
}
if(compile_data){
  germany = compileDataDE(start_date = start_date, end_date = end_date,
                          pm = pm)
  saveRDS(germany, file.path(envrmt$path_tmp, savefile))
} else {
  germany = readRDS(file.path(envrmt$path_tmp, savefile))
}

# Compute additional datasets --------------------------------------------------
de_clstr = germany$de_clstr$clstr
de_model_lag = compileLaggedGLM(de_clstr)
de_model_geo = compileLaggedGLMGeo(de_model_lag, germany$de_nuts3_map)
```


# Figure 1

## Figure 1a

a, Geographic distribution of total confirmed SARS-CoV-2 infections in Germany on April 1st 2020.
```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = TRUE}
background_map = st_transform(ne_countries(scale = "large", continent = "europe", returnclass = "sf"),
                              crs = "+init=epsg:32632")
layer = st_transform(germany$de_nuts3_map, crs = "+init=epsg:32632")

figure_1a = ggplot(data = background_map) +
  geom_sf() + 
  geom_sf(data = layer, aes(fill = cases)) +
  scale_fill_viridis_c(trans = "log10") +
  theme(legend.position="bottom") +
  labs(fill = "Infections (01.04.2020)") +
  coord_sf(xlim = c((st_bbox(layer)["xmin"] - 10000), 
                    (st_bbox(layer)["xmax"] + 10000)), 
           ylim = c((st_bbox(layer)["ymin"] - 25000),
                    (st_bbox(layer)["ymax"] + 10000)), expand = FALSE) + 
  annotation_north_arrow(location = "tl", which_north = "true",
                         height = unit(0.75, "cm"), width = unit(0.75, "cm"),
                         pad_x = unit(0.0, "in"), pad_y = unit(0.1, "in"),
                         style = north_arrow_minimal)

# ggsave(file.path(envrmt$path_figures, "figure_1a.png"), plot = figure_1a,
#        dpi = 600)
# 
# print(figure_1a)
```

## Figure 1b

b, Geographic distribution of the effect size.
```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = TRUE}
background_map = st_transform(ne_countries(scale = "large", continent = "europe", returnclass = "sf"),
                              crs = "+init=epsg:32632")
layer = st_set_geometry(de_model_geo$test_geo[de_model_geo$test_geo$lag == -12, ], de_model_geo$test_geo$geometry[de_model_geo$test_geo$lag == -12, ])
layer = st_transform(layer, crs = "+init=epsg:32632")

figure_1b = ggplot(data = background_map) +
  geom_sf() + 
  geom_sf(data = layer, aes(fill = t)) +
  scale_fill_viridis_c() +
  theme(legend.position="bottom") +
  labs(fill = "Effect size, lag -12 days") +
  coord_sf(xlim = c((st_bbox(layer)["xmin"] - 10000), 
                    (st_bbox(layer)["xmax"] + 10000)), 
           ylim = c((st_bbox(layer)["ymin"] - 25000),
                    (st_bbox(layer)["ymax"] + 10000)), expand = FALSE) + 
  annotation_north_arrow(location = "tl", which_north = "true",
                         height = unit(0.5, "cm"), width = unit(0.5, "cm"),
                         pad_x = unit(0.0, "in"), pad_y = unit(0.1, "in"),
                         style = north_arrow_minimal)

# ggsave(file.path(envrmt$path_figures, "figure_1b.png"), plot = figure_1b,
#        dpi = 600)
# 
# print(figure_2e)



```

## Figure 1c

c, Raw data on PM2.5 has been provided by the German environmental protection agency (UBN) and WAQI. ...

Data on total daily COVID-19 cases and deaths has been provided by the Robert-Koch-Institut. For some analysis, the data has been smoothed using a gaussian loess function with span 0.3 to reduce variation due to delayed reporting over the weekend and especcially on Sunday and Monday. The daily number of new infections has been computed from the daily variations of the total confirmed numbers.

The following figure shows the countrywide average of daily PM2.5 and smoothed COVID-19 new infections. Black vertical dotted lines represent the start of the contact restrictions (March 14th) and shut down (March 17th).
```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
de_avg = germany$de_avg
figure_1c = ggplot() + 
  geom_line(data = de_avg, aes(x = date, y = pm_mean, color = "Daily mean PM10")) +
  geom_point(data = de_avg, aes(x = date, y = pm_mean, color = "Daily mean PM10")) + 
  geom_line(data = de_avg, aes(x = date, y = new_cases, color = "Daily new cases")) +
  geom_point(data = de_avg, aes(x = date, y = new_cases, color = "Daily new cases")) + 
  geom_line(data = de_avg, aes(x = date, y = new_cases_detr, color = "Daily new cases, detrended"), linetype = "twodash") +
  geom_vline(xintercept = as.POSIXct("2020-03-14"), linetype="dotted", color = "black") +
  geom_vline(xintercept = as.POSIXct("2020-03-17"), linetype="dotted", color = "black") +
  geom_text(aes(x = as.POSIXct("2020-03-14"), label="Start of contact restrictions \n", y=35), colour="black", angle=90) +
  geom_text(aes(x = as.POSIXct("2020-03-17"), label="Start of shut down \n", y=35), colour="black", angle=90) +
  labs(x = "Date and day of week", y = NULL) +
  theme_bw() + 
  scale_x_datetime(date_labels = "%d.%m, %a", date_breaks = "1 day") + 
  scale_color_manual(values=c("blue", "red", "red")) +
  theme(legend.position = c(0.2, 0.9), axis.text.x = element_text(angle=90, hjust=0.95, vjust=0.2), 
        legend.title = element_blank(), panel.background = element_blank(),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# ggsave(file.path(envrmt$path_figures, "figure_1c.png"), plot = figure_1c,
#        dpi = 300)
# 
# print(figure_1b)
```


## Figure 1 combined

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
figure_1 = plot_grid(figure_1a, figure_1b, figure_1c, labels = "auto")
ggsave(file.path(envrmt$path_figures, "figure_1.png"), plot = figure_1, dpi = 300)
```


# Figure 2

## Figure 2a

Dependence of individual COVID-19 time series and lagged PM10 concentrations.
effect size = t-value of the partial coefficient.

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
figure_2a = ggplot(data = de_model_lag, aes(x = as.factor(lag), y = t)) + 
  geom_boxplot() + 
  theme_bw() +
  geom_hline(yintercept = c(-2, 2), linetype="dashed", color = "black") + 
  labs(x = "Time lag PM10 (days)", y = "Effect size") + 
  theme(panel.background = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

# ggsave(file.path(envrmt$path_figures, "figure_2a.png"), plot = figure_2a,
#        dpi = 600)
# 
# print(figure_2a)
```


# Figure 2b

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
# ggplot(data = de_model_geo$test_geo_lag) +
#   geom_line(aes(x = lag, y = rsq, color = "R squared")) +
#   geom_point(aes(x = lag, y = rsq, color = "R squared")) +
#   theme_bw() +
#   scale_x_continuous(breaks = seq(-15, 0, 1), minor_breaks = seq(-15, 0, 1)) +
#   labs(title = paste("R squared values of lagged ", pm,
#                      " concentrations based on latitude, longitude and area",
#                      x = "Time lag PM [days]"), y = "R squared",
#        color = "R squared")


figure_2b = ggplot(data = de_model_geo$test_geo_lag) + 
  geom_line(aes(x = lag, y = centroid_lat_t, color = "Latitude")) +
  geom_point(aes(x = lag, y = centroid_lat_t, color = "Latitude")) +
  geom_line(aes(x = lag, y = centroid_lon_t, color = "Longitude")) +
  geom_point(aes(x = lag, y = centroid_lon_t, color = "Longitude")) +
  geom_line(aes(x = lag, y = area_t, color = "Log10(area)")) +
  geom_point(aes(x = lag, y = area_t, color = "Log10(area)")) +
  scale_x_continuous(breaks = seq(-15, 0, 1), minor_breaks = seq(-15, 0, 1)) +
  theme_bw() + 
  geom_hline(yintercept = c(-2, 2), linetype="dashed", color = "black") + 
  labs(x = "Time lag PM10 (days)", y = "Effect size", 
       color = "") + 
  theme(legend.position = c(0.8, 0.8), panel.background = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())


# ggsave(file.path(envrmt$path_figures, "figure_2b.png"), plot = figure_2b,
#        dpi = 600)
# 
# print(figure_2b)
```

## Figure 2c 

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
figure_2c = ggplot() + 
  geom_point(data = de_model_geo$test_geo[de_model_geo$test_geo$lag <= -10, ], 
             aes(x = centroid_lat, y = t, fill = as.factor(lag), 
                 shape = as.factor(lag), size = as.factor(lag))) +
  scale_shape_manual(values = c(22, 23, 21, 24, 25)) +
  scale_fill_manual(values = c('grey', 'grey','red', 'grey', 'grey')) +
  scale_size_manual(values = c(1.5, 1.5, 3, 1.5, 1.5)) + 
  geom_smooth(data = de_model_geo$test_geo[de_model_geo$test_geo$lag == -12, ], 
              aes(x = centroid_lat, y = t, ), method = "lm", color = "red")+
  theme_bw() + 
  geom_hline(yintercept = c(-2, 2), linetype="dashed", color = "black") + 
  scale_x_continuous(breaks = seq(47, 55, 1)) + 
  scale_y_continuous(breaks = seq(-10, 20, 2)) +
  labs(x = "Latitude (degrees)", y = "Effect size", 
       fill = "", shape = "", size = "") + 
  theme(legend.position = c(0.65, 0.08), legend.direction="horizontal", 
        panel.background = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())
 

# ggsave(file.path(envrmt$path_figures, "figure_2c.png"), plot = figure_2c,
#        dpi = 600)
# 
# print(figure_2c)

```


## Figure 2d 

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
figure_2d = ggplot() + 
  geom_point(data = de_model_geo$test_geo[de_model_geo$test_geo$lag >= -8 &
                                            de_model_geo$test_geo$lag <= -3, ], 
             aes(x = centroid_lat, y = t, fill = as.factor(lag), 
                 shape = as.factor(lag), size = as.factor(lag))) +
  scale_shape_manual(values = c(22, 23, 21, 24, 25, 21)) +
  scale_fill_manual(values = c('grey', 'grey','red', 'grey', 'grey', "blue")) +
  scale_size_manual(values = c(1.5, 1.5, 3, 1.5, 1.5, 3)) + 
  geom_smooth(data = de_model_geo$test_geo[de_model_geo$test_geo$lag == -6, ], 
              aes(x = centroid_lat, y = t, ), method = "lm", color = "red")+
  theme_bw() + 
  geom_hline(yintercept = c(-2, 2), linetype="dashed", color = "black") + 
  scale_x_continuous(breaks = seq(47, 55, 1)) + 
  scale_y_continuous(breaks = seq(-10, 20, 2)) +
  labs(x = "Latitude (degrees)", y = "Effect size", 
       fill = "", shape = "", size = "") + 
  theme(legend.position = c(0.3, 0.09), legend.direction="horizontal", 
        panel.background = element_blank(), panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())


# ggsave(file.path(envrmt$path_figures, "figure_2d.png"), plot = figure_2d,
#        dpi = 600)
# 
# print(figure_2c)

```



## Figure 2 combined

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
figure_2 = plot_grid(figure_2a, figure_2b, figure_2c, figure_2d, figure_1b, figure_1a, labels = "auto", ncol = 3)


# figure_2 = plot_grid(figure_2a, figure_2b, figure_2c, figure_2d, labels = "auto")
ggsave(file.path(envrmt$path_figures, "figure_2_alternative.png"), plot = figure_2, dpi = 300)
```


