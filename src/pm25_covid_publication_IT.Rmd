---
title: "Correlation of PM2.5 concentrations and SARS-CoV-2 infection"
always_allow_html: true
editor_options:
  chunk_output_type: console
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Set up working environment and defaults --------------------------------------
library(envimaR)
if(Sys.info()[["nodename"]] == "PC19616"){
  source("~/plygrnd/CovidAirPolution/CovidAirPolution/src/functions/000_setup.R")
} else {
  source("~/project/cov/CovidAirPolution/src/functions/000_setup.R")  
}
compile_data = TRUE

start_date = as.POSIXct("2020-02-15")
end_date = as.POSIXct("2020-04-01")

# Load Italy -------------------------------------------------------------------
if(compile_data){
  italy = compileDataIT(city = FALSE, start_date = start_date, end_date = end_date)
  saveRDS(italy, file.path(envrmt$path_tmp, "italy.RDS"))
} else {
  italy = readRDS(file.path(envrmt$path_tmp, "italy.RDS"))
}

```

# Map of NUTS 3 regions with available PM2.5 in

The data is availabe for the following nuts 3 regions.

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = TRUE}
print(paste("Start date for analysis: ", start_date))
print(paste("End date for analysis:   ", end_date))

mapview(italy$it_nuts3_map, zcol = "cases")
```


# Countrywide temporal development of PM2.5 values and COVID-19 cases in Italy

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
it_avg = italy$it_avg
ggplot() + 
  geom_line(data = it_avg, aes(x = date, y = pm_mean, color = "PM2.5")) + 
  geom_line(data = it_avg, aes(x = date, y = new_cases, color = "New cases")) + 
  labs(title = "PM2.5 x daily new Covid-19 cases", x = "Date", y = "Value") +
  geom_vline(xintercept = as.POSIXct("2020-03-13"), linetype="dotted", color = "black") +
  theme_bw() + 
  scale_x_datetime(date_labels = "%d.%m - %a", date_breaks = "1 day") + 
  scale_color_manual(values=c("red", "blue")) +
  theme(axis.text.x = element_text(angle=90)) + 
  theme(legend.title = element_blank())
```



```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
it_avg = italy$it_avg
ggplot() + 
  geom_line(data = it_avg, aes(x = date, y = pm_mean, color = "PM2.5")) + 
  geom_line(data = it_avg, aes(x = date, y = new_cases_detr, color = "New cases (smoothed, detrended)")) +
  geom_line(data = it_avg, aes(x = date, y = new_cases, color = "New cases (smoothed)")) + 
  labs(title = "PM2.5 x daily new Covid-19 cases (smoothed, detrended)", x = "Date", y = "Value") +
  geom_vline(xintercept = as.POSIXct("2020-03-13"), linetype="dotted", color = "black") +
  theme_bw() + 
  scale_x_datetime(date_labels = "%d.%m - %a", date_breaks = "1 day") + 
  scale_color_manual(values=c("red", "darkgreen", "blue")) +
  theme(axis.text.x = element_text(angle=90)) + 
  theme(legend.title = element_blank())
```


## Wavelet coherence analysis on countrywide average

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
it_avg = italy$it_avg
wc = compileWCIT(it_avg)

wc.image(wc, which.image = "wc",
         n.levels = 250, color.key = "interval",
         siglvl.contour = 0.1, siglvl.arrow = 0.1,
         legend.params = list(lab = "cross-wavelet power levels"), show.date = TRUE,
         spec.period.axis = list(at = seq(15)),
         main = "Wavelet coherence Italy, PM2.5 x detrended daily COVID-19 cases")

# wc.sel.phases(wc, sel.period = 4, siglvl = 1, show.date = TRUE)
```

The analysis shows that for the period of 4 to 6 days, the PM2.5 time series is leading arround March 1 with up to 2 or 3 days (arrows towards right upward). The situation changes towards April 1st. Here the COVID-19 cases are taking over the lead, with a time lag about 25% of the period. The relationship is also inverted mainly as a consequence of the sharp increase in PM2.5 values due to a Sahara dust event.


# Analyis 2: Dynmiac time warp clustering on countrywide average

The map shows clusters (different colors) with similar development of smoothed daily COVID-19 new infections. Cluster ID and number (n) of nuts 3 regions within each cluster is given in the legend.

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = TRUE}
mapview(italy$it_clstr$clstr_map, zcol = "cluster_covid")
mapview(italy$it_clstr$clstr_map, zcol = "cluster_pm")
```


The plots show the average of daily PM2.5 and smoothed new infections along with their detrened infection series within each cluster. Cluster ID and number (n) of nuts 3 regions within each cluster is given in the figure headers.

```{r, eval = TRUE, echo=FALSE, warning=FALSE, message=FALSE}
it_clstr = italy$it_clstr
ggplot() + 
  geom_line(data = it_clstr$clstr_avg_detr, aes(x = date, y = pm_mean, color = "PM2.5")) + 
  geom_line(data = it_clstr$clstr_avg_detr, aes(x = date, y = new_cases, color = "New cases")) + 
  geom_line(data = it_clstr$clstr_avg_detr, aes(x = date, y = new_cases_detr*5, color = "New cases (detrended)")) +
  geom_vline(xintercept = as.POSIXct("2020-03-13"), linetype="dotted", color = "black") +
  theme_bw() + 
  labs(title = "PM2.5 x daily new Covid-19 cases (smoothed, detrended)", x = "Date", y = "Value") +
  scale_x_datetime(date_labels = "%d.%m - %a", date_breaks = "1 day") + 
  scale_color_manual(values=c("red", "darkgreen", "blue")) +
  theme(axis.text.x = element_text(angle=90)) + 
  theme(legend.title = element_blank()) +
  facet_wrap(~cluster_pm, ncol =2, nrow = 2, scales = "fix")
```


## Wavelet coherence analysis on cluster averages

The wavelet coherence analysis for each cluster reveals some considerable differences.

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
it_clstr = italy$it_clstr
for(c in unique(it_clstr$clstr_avg_detr$cluster_pm)){
  tmp = it_clstr$clstr_avg_detr[it_clstr$clstr_avg_detr$cluster_pm == c,]
  wc = compileWCIT(tmp)
  
  wc.image(wc, which.image = "wc",
           n.levels = 250, color.key = "interval",
           siglvl.contour = 0.1, siglvl.arrow = 0.1,
           legend.params = list(lab = "cross-wavelet power levels"), show.date = TRUE,
           spec.period.axis = list(at = seq(15)),
           main = paste("Italy, PM2.5 x detrended daily COVID-19 cases, cluster ", c))
  
  # wc.sel.phases(wc, sel.period = 4, siglvl = 1, show.date = TRUE)
}
```


# Explanatory potential of PM2.5 for COVID-19 cases

## Generalized linear models

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
it_clstr = italy$it_clstr$clstr
it_model_lag = compileLaggedGLM(it_clstr)
```


```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
ggplot(data = it_model_lag, aes(x = as.factor(lag), y = t)) + 
  geom_boxplot() + 
  theme_bw() +
  geom_hline(yintercept = c(-2, 2), linetype="dashed", color = "red") + 
  labs(title = "Dependence of individual COVID-19 time series and lagged PM2.5 concentrations",x = "Time lag PM2.5 [days]", y = "t value of the partial coefficient")
```


```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
ggplot(data = it_model_lag, aes(x = as.factor(lag), y = t, fill = cluster_pm)) + 
  geom_boxplot() + 
  theme_bw() + 
  geom_hline(yintercept = c(-2, 2), linetype="dashed", color = "red") + 
  labs(title = "Dependence of individual COVID-19 time series and lagged PM2.5 concentrations by PM2.5 clusters",x = "Time lag PM2.5 [days]", y = "t value of the partial coefficient")
```


The following shows the R squared and t values resulting from a GLM model that relates the t value of the PM2.5 partial coefficient from the model above to latitude, longitude and area.

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
it_model_geo = compileLaggedGLMGeoIT(it_model_lag, italy$it_nuts3_map)

ggplot(data = it_model_geo$test_geo_lag) + 
  geom_line(aes(x = lag, y = rsq, color = "R squared")) +
  geom_point(aes(x = lag, y = rsq, color = "R squared")) +
  theme_bw() + 
  scale_x_continuous(breaks = seq(-15, 0, 1), minor_breaks = seq(-15, 0, 1)) + 
  labs(title = "R squared values of lagged PM2.5 concentrations based on latitude, longitude and area",x = "Time lag PM2.5 [days]", y = "R squared", color = "R squared")


ggplot(data = it_model_geo$test_geo_lag) + 
  geom_line(aes(x = lag, y = lat_t, color = "latitude")) +
  geom_point(aes(x = lag, y = lat_t, color = "latitude")) +
  geom_line(aes(x = lag, y = lon_t, color = "longitude")) +
  geom_point(aes(x = lag, y = lon_t, color = "longitude")) +
  geom_line(aes(x = lag, y = area_t, color = "log10(area)")) +
  geom_point(aes(x = lag, y = area_t, color = "log10(area)")) +
  theme_bw() + 
  geom_hline(yintercept = c(-2, 2), linetype="dashed", color = "black") + 
  scale_x_continuous(breaks = seq(-15, 0, 1), minor_breaks = seq(-15, 0, 1)) + 
  labs(title = "t values of lagged PM2.5 concentrations for latitude, longitude and area",x = "Time lag PM2.5 [days]", y = "t value of the partial coefficient", color = "Partial coefficient")


ggplot(data = it_model_geo$test_geo[it_model_geo$test_geo$lag >= -3 & it_model_geo$test_geo$lag <= -1,]) + 
  geom_point(aes(x = lat, y = t, color = as.factor(lag))) +
  theme_bw() + 
  geom_hline(yintercept = c(-2, 2), linetype="dashed", color = "black") + 
  scale_x_continuous(breaks = seq(41, 48, 1)) + 
  labs(title = "t values of PM2.5 concentrations lag -3 to -1 against latitude",x = "Latitude [degrees]", y = "t value of the partial coefficient for PM2.5 (glm model)", color = "Lag of PM2.5")


ggplot(data = it_model_geo$test_geo[it_model_geo$test_geo$lag >= -9 & it_model_geo$test_geo$lag <= -7,]) + 
  geom_point(aes(x = lat, y = t, color = as.factor(lag))) +
  theme_bw() + 
  geom_hline(yintercept = c(-2, 2), linetype="dashed", color = "black") + 
  scale_x_continuous(breaks = seq(41, 48, 1)) + 
  labs(title = "t values of PM2.5 concentrations lag -7 to -9 against latitude",x = "Latitude [degrees]", y = "t value of the partial coefficient for PM2.5 (glm model)", color = "Lag of PM2.5")
```

Hier mal ein Versuch, die Italien-Grafik in https://www.medrxiv.org/content/10.1101/2020.04.15.20065995v2 etwas nachzubauen. Auch hier - nur zufällig signifikant - ich vermute auch dort. Dafür sind bei unseren Italien-Daten die Cluster eindeutiger.

Italien vielleicht in Supplements?

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = TRUE}
# 10, 12

test = italy$it_clstr$clstr[italy$it_clstr$clstr$date < as.POSIXct("2020-03-01"),] %>%
    group_by(nuts3Code) %>%
    summarize(n_days = n(),
              pm_gt_10 = sum(pm_mean > 100),
              pm_gt_10_rel = pm_gt_10 / n_days)
test_merge = merge(test, italy$it_clstr$clstr[italy$it_clstr$clstr$date == as.POSIXct("2020-03-07"),])
test_merge = merge(test_merge, st_set_geometry(italy$it_nuts3_map, NULL)[, c("nuts3Code", "area")])
test_merge$ratio = as.numeric(test_merge$cases/test_merge$area)

ggplot(data = test_merge, aes(x = pm_gt_10, y = ratio)) + 
  geom_point() +
  geom_smooth(method = "glm") +
  theme_bw() + 
  scale_y_log10() +
  labs(title = "COVID-19 infections per province area (07.03.) and days exceeding PM > 100 from 15.2. to 3.1.")

model = glm(test_merge$ratio ~ test_merge$pm_gt_10, family = quasipoisson)
summary(model)
```
