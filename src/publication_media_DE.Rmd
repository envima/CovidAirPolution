---
title: "Media for the publication on the correlation between PM and SARS-CoV-2 infections in Germany"
author: "Thomas Nauss et al."
always_allow_html: true
editor_options:
  chunk_output_type: console
output:
  html_document:
    df_print: paged
  pdf_document: default
---


```{r, echo=FALSE, warning=FALSE, message=FALSE}

# Set up working environment and load graphics.
library(envimaR)
if (Sys.info()[["nodename"]] == "PC19616") {
  source("~/plygrnd/CovidAirPolution/CovidAirPolution/src/functions/000_setup.R")
} else {
  source("~/project/cov/CovidAirPolution/src/functions/000_setup.R")
}

figure_cntry_avg <- readRDS(file.path(envrmt$path_figures, "figure_cntry_avg.rds"))
figure_gam_lag_set <- readRDS(file.path(envrmt$path_figures, "figure_gam_lag_set.rds"))
figure_gam_lag_mixed_set <- readRDS(file.path(envrmt$path_figures, "figure_gam_lag_mixed_set.rds"))
figure_cumulative_effect <- readRDS(file.path(envrmt$path_figures, "figure_cumulative_effect.rds"))
map_covid_infections <- readRDS(file.path(envrmt$path_figures, "map_covid_infections.rds"))
map_pm_mean <- readRDS(file.path(envrmt$path_figures, "map_pm_mean.rds"))
lm_tavrg_smry <- readRDS(file.path(envrmt$path_figures, "lm_tavrg_smry.rds"))
lm_tavrg_stpAIC_smry <- readRDS(file.path(envrmt$path_figures, "lm_tavrg_stpAIC_smry.rds"))

lag_var <- "pm_mean_estm_best"
```



# Fig. 1: Country wide reported SARS-CoV-2 infections and PM10 concentrations.

a, Chronology of reported daily new SARS-CoV-2 infections (blue) and PM10 concentrations (µg m-3, green) between March 15th 2020 and April 20th averaged over all rural and city districts considered in this study. Daily infections and particle matter concentrations show a weekly cycle but for the infections, this cycle is artificial and due to differences in testing and reporting over the week. This effect is considered in the generalized additive model that explains daily new infections by time and the day of week (light blue). Black vertical dotted lines represent the start of the contact restrictions (March 14th) and of the shutdown (March 17th) in Germany. b,c, Dynamics of daily PM10 cocentrations (b) and daily new SARS-CoV-2 infections (c) of the individual districts. d,e, Maps of the districts included in this study showing cumulative infections on April 1st 2020 (d) and PM10 concentrations (µg m-3) averaged between February 15th and April 1st 2020 (e).

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}

# names(.GlobalEnv)[grep("figure", names(.GlobalEnv))]
# names(.GlobalEnv)[grep("map", names(.GlobalEnv))]
# plot(rd)


figure_1_1 <- plot_grid(figure_cntry_avg$PM10$cntry_avg, 
                        figure_cntry_avg$PM10$cntry_avg_pm, 
                        figure_cntry_avg$PM10$cntry_avg_covid, 
                        labels = c("a", "b", "c"), label_size = 12, ncol = 1)

figure_1_2 <- plot_grid(map_covid_infections$PM10, map_pm_mean$PM10, labels = c("d", "e"), label_size = 12, ncol = 2)

figure_1 <- plot_grid(figure_1_1, figure_1_2, labels = NULL, ncol = 1)
ggsave(file.path(envrmt$path_figures, "figure_1.png"),
       plot = figure_1,
       width = 347, height = 450, units = "mm", dpi = 300
)
```



# Fig. 2: Country wide reported SARS-CoV-2 infections and PM10 concentrations.

Fig. 2: (a) Relationship between log10-transformed cumulative infections on April 1st 2020 on a district level and corresponding log10-transformed median PM10 concentrations (g m-3) between March 15th 2020 and April 20th, centroid latitude and longitude of the district, log10-transformed population number, log10-transformed district area and time difference between the first COVID-19 infection and the shutdown date of March 17th 2020 (negative values indicate a first infection case of n days prior to the shutdown) (a). Using individual generalized additive model for each district with time as smooth term, weekday as factor and daily PM10 concentrations, the effect size of PM10 concentrations is significantly positive for time lags of 0, -1 and -3 (b). Further significant time lags (indicated by green boxplots) are all negative. The number of (positive) significant time lags (red error bars of the PM10 estimate) increases if a generalized additive mixed model is applied to the data of all districts with district as random effect (c).

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}

figure_2_1 <- plot_grid(figure_cumulative_effect$PM10$cumulative_effect_log,
                        figure_cumulative_effect$PM10$cumulative_effect,
                        labels = c("a", "b"), label_size = 10, ncol = 1
)

figure_2_2 <- plot_grid(figure_gam_lag_set$PM10$pm_mean_estm_best, figure_gam_lag_mixed_set$PM10$pm_mean_estm_best$estimate_mixed,
                        labels = c("c", "d"), label_size = 10, ncol = 2
)

figure_2 <- plot_grid(figure_2_1, figure_2_2,
                      labels = NULL, ncol = 1
)

ggsave(file.path(envrmt$path_figures, "figure_2.png"),
       plot = figure_2,
       width = 347, height = 450, units = "mm", dpi = 300
)

```
























```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}

# names(.GlobalEnv)[grep("figure", names(.GlobalEnv))]
# names(.GlobalEnv)[grep("map", names(.GlobalEnv))]
# plot(rd)


figure_1_1 <- plot_grid(figure_cntry_avg, figure_cntry_avg_res,
                        labels = c("a", "b"), label_size = 10, ncol = 1
)
figure_1_2 <- plot_grid(map_covid_infections, map_pm_median,
                        labels = c("c", "d"), label_size = 10, ncol = 2
)
figure_1 <- plot_grid(figure_1_1, figure_1_2,
                      labels = NULL, ncol = 1
)

ggsave(file.path(envrmt$path_figures, "figure_1.png"),
       plot = figure_1,
       width = 216, height = 279, units = "mm", dpi = 300
)



pdf(NULL, width = 5, height = 10)
dev.control(displaylist = "enable")
plot(rd, type = "points", scaling = 0)
figure_rda <- recordPlot()
invisible(dev.off())

figure_2_1 <- plot_grid(figure_cumulative_effect,
                        labels = c("a"), label_size = 10, ncol = 1
)

figure_2_2 <- plot_grid(figure_effectsize, figure_estimate_mixed,
                        labels = c("b", "c"), label_size = 10, ncol = 2
)

figure_2_2_alternative <- plot_grid(figure_effectsize, figure_effectsize_mixed,
                                    labels = c("b", "c"), label_size = 10, ncol = 2
)

figure_2 <- plot_grid(figure_2_1, figure_2_2,
                      labels = NULL, ncol = 1
)

figure_2_alternative <- plot_grid(figure_2_1, figure_2_2_alternative,
                                  labels = NULL, ncol = 1
)

ggsave(file.path(envrmt$path_figures, "figure_2.png"),
       plot = figure_2,
       width = 216, height = 279, units = "mm", dpi = 300
)

ggsave(file.path(envrmt$path_figures, "figure_2_alternative.png"),
       plot = figure_2_alternative,
       width = 216, height = 279, units = "mm", dpi = 300
)
```









# Countrywide temporal development of PM values and SARS-CoV2 infections

This analysis part is based on countrywide averaged data. A GAM model is computed to predict the daily new cases explained by time. The figures show the mean daily PM and covid cases dynamics as well as the daily new cases if time is used as explanatory variable for SARS-CoV2 infections.





# Correlation of PM and SARS-CoV2 infections individually by district

This analysis part is based on individual rural district data. A GAM model is computed to evaluate the influence of lagged PM concentrations on daily new SARS-CoV2 infections. The figures show the effect size of the model for the individual time lags.






# Correlation of PM and SARS-CoV2 infections with district as random effect

This analysis part is based on individual rural district data. A mixed effect GAM model with district as random effect is computed to evaluate the influence of lagged PM concentrations on daily new SARS-CoV2 infections. The figure shows the effect size of the model for the individual time lags.




# Longer-term correlation of PM and SARS-CoV2 infections

This analysis part is based on individual rural district data that is averaged over time from the start of the data series to April 1st. A linear model is computed to evaluate the influence of longer-term averaged PM concentrations on cummulative SARS-CoV2 infections on April 1st. The figure shows scatterplots between the cumulative infection number and a set of explanatory variables used within the linear model.


# Maps

Create some maps based on previous results.












































# Geographical distribution of SARS-CoV2 infections in cmpldata
```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = TRUE}
print(paste("Start date for analysis: ", start_date))
print(paste("End date for analysis:   ", end_date))
print(paste("PM values:               ", pm))

cmpldata$de_nuts3_map$log_cases <- log10(cmpldata$de_nuts3_map$cases)
mapview(cmpldata$de_nuts3_map, zcol = "log_cases")




figure_cntry_avg_res <- ggplot() +
  geom_line(data = cntry_avg_gam, aes(x = date, y = residuals, color = "Residuals")) +
  geom_point(data = cntry_avg_gam, aes(x = date, y = residuals, color = "Residuals")) +
  geom_vline(xintercept = as.POSIXct("2020-03-14"), linetype = "dotted", color = "black") +
  geom_vline(xintercept = as.POSIXct("2020-03-17"), linetype = "dotted", color = "black") +
  geom_text(aes(
    x = as.POSIXct("2020-03-14"),
    label = "Start of contact restrictions \n", y = -0.6
  ), colour = "black", angle = 90, size = 2) +
  geom_text(aes(
    x = as.POSIXct("2020-03-17"),
    label = "Start of shut down \n", y = -0.65
  ), colour = "black", angle = 90, size = 2) +
  labs(x = "Date and day of week", y = "Residuals") +
  theme_bw() +
  scale_x_datetime(date_labels = "%d.%m, %a", date_breaks = "2 day", date_minor_breaks = "1 day") +
  scale_color_manual(values = c("#d95f02")) +
  theme(
    text = element_text(size = 10), axis.title = element_text(size = 10),
    legend.position = "none", axis.text.x = element_text(angle = 90, hjust = 0.95, vjust = 0.2),
    legend.title = element_blank(), panel.background = element_blank(),
    panel.grid.major = element_blank(), panel.grid.minor = element_blank()
  )
figure_cntry_avg_res
```







# Redundancy analysis of the lagged effect sizes

The analysis part is based on former and additional results and aims in providing additional information regarding the dependencies of SARS-CoV2 infections. The figure shows the results of a redundancy analysis of the lagged effect sizes.

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}

# summary(as.numeric(add_info$difftime_start_max))
# summary(as.numeric(add_info$first_shutdown))
# summary(as.numeric(add_info$max_shutdown))
# summary(add_info$daily_max)
#
# hist(as.numeric(add_info$difftime_start_max))
# hist(as.numeric(add_info$first_shutdown))
# hist(as.numeric(add_info$max_shutdown))

t_matrix <- reshape(gam_lag[, c("nuts3Code", "t", "lag")], idvar = "nuts3Code", timevar = "lag", direction = "wide")
rownames(t_matrix) <- t_matrix$nuts3Code

t_environment <- merge(cmpldata$de_nuts3_map, add_info)
t_environment <- st_drop_geometry(t_environment)
t_matrix <- merge(t_matrix, t_environment, by = "nuts3Code")

# Log transform some variables and rename for figure.
t_matrix$PM <- log10(t_matrix$pm_median)
t_matrix$Population <- log10(t_matrix$pop_total)
t_matrix$Area <- log10(t_matrix$st_area)
t_matrix$Cases <- log10(t_matrix$cases)
t_matrix$First <- t_matrix$difftime_first_shutdown
t_matrix$Latitude <- t_matrix$centroid_lat
t_matrix$Longitude <- t_matrix$centroid_lon

rd <- rda(
  t_matrix[, seq(which(colnames(t_matrix) == "t.0"), which(colnames(t_matrix) == "t.-15"))],
  t_matrix[, c("PM", "Cases", "Population", "Area", "First", "Latitude", "Longitude")]
)
plot(rd, type = "points", scaling = 0)
```







# Maps
```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
# SARS-CoV2 infections on 2020-04-01
background_map <- st_transform(ne_countries(scale = "large", continent = "europe", returnclass = "sf"),
                               crs = "+init=epsg:25832"
)
layer <- st_transform(cmpldata$de_nuts3_map, crs = "+init=epsg:25832")
map_covid_infections <- ggplot(data = background_map) +
  geom_sf() +
  geom_sf(data = layer, aes(fill = cases)) +
  scale_fill_viridis_c(trans = "log10") +
  theme(
    text = element_text(size = 10), axis.title = element_text(size = 10),
    legend.position = "bottom"
  ) +
  labs(fill = "Infections (01.04.2020)") +
  coord_sf(
    xlim = c(
      (st_bbox(layer)["xmin"] - 10000),
      (st_bbox(layer)["xmax"] + 10000)
    ),
    ylim = c(
      (st_bbox(layer)["ymin"] - 25000),
      (st_bbox(layer)["ymax"] + 10000)
    ), expand = FALSE
  ) +
  annotation_north_arrow(
    location = "tl", which_north = "true",
    height = unit(0.75, "cm"), width = unit(0.75, "cm"),
    pad_x = unit(0.0, "in"), pad_y = unit(0.1, "in"),
    style = north_arrow_minimal
  )
map_covid_infections


# Long-term PM median between 2020-02-15 and 2020-04-01
background_map <- st_transform(ne_countries(scale = "large", continent = "europe", returnclass = "sf"),
                               crs = "+init=epsg:25832"
)
layer <- st_transform(cmpldata$de_nuts3_map, crs = "+init=epsg:25832")
map_pm_median <- ggplot(data = background_map) +
  geom_sf() +
  geom_sf(data = layer, aes(fill = pm_median)) +
  scale_fill_viridis_c(trans = "log10") +
  theme(
    text = element_text(size = 10), axis.title = element_text(size = 10),
    legend.position = "bottom"
  ) +
  labs(fill = "PM10 median 15.02.2020 - 01.04.2020") +
  coord_sf(
    xlim = c(
      (st_bbox(layer)["xmin"] - 10000),
      (st_bbox(layer)["xmax"] + 10000)
    ),
    ylim = c(
      (st_bbox(layer)["ymin"] - 25000),
      (st_bbox(layer)["ymax"] + 10000)
    ), expand = FALSE
  ) +
  annotation_north_arrow(
    location = "tl", which_north = "true",
    height = unit(0.75, "cm"), width = unit(0.75, "cm"),
    pad_x = unit(0.0, "in"), pad_y = unit(0.1, "in"),
    style = north_arrow_minimal
  )
map_pm_median



# RDA1 values
score_geo <- cbind(t_matrix$nuts3Code, scores(rd)$sites)
colnames(score_geo)[1] <- "nuts3Code"
score_geo <- merge(score_geo, unique(de_clstr[, "nuts3Code"]))
st_geometry(score_geo) <- score_geo$geometry

background_map <- st_transform(ne_countries(scale = "large", continent = "europe", returnclass = "sf"),
                               crs = "+init=epsg:25832"
)
layer <- st_transform(score_geo, crs = "+init=epsg:25832")
map_rda1_score <- ggplot(data = background_map) +
  geom_sf() +
  geom_sf(data = layer, aes(fill = RDA1)) +
  theme(legend.position = "bottom") +
  labs(fill = "RDA1") +
  coord_sf(
    xlim = c(
      (st_bbox(layer)["xmin"] - 10000),
      (st_bbox(layer)["xmax"] + 10000)
    ),
    ylim = c(
      (st_bbox(layer)["ymin"] - 25000),
      (st_bbox(layer)["ymax"] + 10000)
    ), expand = FALSE
  ) +
  annotation_north_arrow(
    location = "tl", which_north = "true",
    height = unit(0.75, "cm"), width = unit(0.75, "cm"),
    pad_x = unit(0.0, "in"), pad_y = unit(0.1, "in"),
    style = north_arrow_minimal
  )
map_rda1_score



# Significant and positive t values
p <- 0.1

lag_analysis <- st_set_geometry(
  gam_lag_geo$test_geo[gam_lag_geo$test_geo$t > 0 &
                         gam_lag_geo$test_geo$p < p, ],
  gam_lag_geo$test_geo$geometry[gam_lag_geo$test_geo$t > 0 &
                                  gam_lag_geo$test_geo$p < p, ]
)

lag_analysis <- lapply(unique(lag_analysis$nuts3Code), function(n) {
  data.frame(
    nuts3Code = lag_analysis$nuts3Code[lag_analysis$nuts3Code == n][1],
    min_lag = max(lag_analysis$lag[lag_analysis$nuts3Code == n]),
    mean_lag = mean(lag_analysis$lag[lag_analysis$nuts3Code == n]),
    max_lag = min(lag_analysis$lag[lag_analysis$nuts3Code == n]),
    geometry = lag_analysis$geometry[lag_analysis$nuts3Code == n][1]
  )
})
lag_analysis <- do.call("rbind", lag_analysis)
lag_analysis <- merge(lag_analysis, cmpldata$de_nuts3_map[, c("nuts3Code", "pm_median", "cases", "pop_dens")])
hist(lag_analysis$min_lag)
hist(lag_analysis$mean_lag)
hist(lag_analysis$max_lag)

non_significant_regions <- cmpldata$de_nuts3_map[!(cmpldata$de_nuts3_map$nuts3Code %in% lag_analysis$nuts3Code), ]

summary(cmpldata$de_nuts3_map[, c("nuts3Code", "pm_median", "cases", "pop_dens")])
summary(lag_analysis)
summary(non_significant_regions[, c("nuts3Code", "pm_median", "cases", "pop_dens")])

quantile(non_significant_regions$pop_dens, probs = seq(0, 1, 0.1))
quantile(lag_analysis$pop_dens, probs = seq(0, 1, 0.1))

wilcox.test(non_significant_regions$cases, lag_analysis$cases)
wilcox.test(non_significant_regions$pm_median, lag_analysis$pm_median)
wilcox.test(non_significant_regions$pop_dens, lag_analysis$pop_dens)

t.test(non_significant_regions$cases, lag_analysis$cases)
t.test(non_significant_regions$pm_median, lag_analysis$pm_median)
t.test(non_significant_regions$pop_dens, lag_analysis$pop_dens)

layer1 <- st_set_geometry(lag_analysis, lag_analysis$geometry)
layer1 <- st_transform(layer1, crs = "+init=epsg:25832")

background_map <- st_transform(ne_countries(scale = "large", continent = "europe", returnclass = "sf"),
                               crs = "+init=epsg:25832"
)
layer <- st_transform(cmpldata$de_nuts3_map, crs = "+init=epsg:25832")

map_t_sig <- ggplot(data = background_map) +
  geom_sf() +
  geom_sf(data = layer) +
  geom_sf(data = layer1, aes(fill = mean_lag)) +
  scale_fill_viridis_c() +
  theme(legend.position = "bottom") +
  labs(fill = "Mean lag of positive effect size") +
  coord_sf(
    xlim = c(
      (st_bbox(layer)["xmin"] - 10000),
      (st_bbox(layer)["xmax"] + 10000)
    ),
    ylim = c(
      (st_bbox(layer)["ymin"] - 25000),
      (st_bbox(layer)["ymax"] + 10000)
    ), expand = FALSE
  ) +
  annotation_north_arrow(
    location = "tl", which_north = "true",
    height = unit(0.5, "cm"), width = unit(0.5, "cm"),
    pad_x = unit(0.0, "in"), pad_y = unit(0.1, "in"),
    style = north_arrow_minimal
  )
map_t_sig
```


# Figures for publication
```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}


figure_effectsize
plot(rd)
map_covid_infections
map_pm_median


figure_1_1 <- plot_grid(figure_cntry_avg, figure_cntry_avg_res,
                        labels = c("a", "b"), label_size = 10, ncol = 1
)
figure_1_2 <- plot_grid(map_covid_infections, map_pm_median,
                        labels = c("c", "d"), label_size = 10, ncol = 2
)
figure_1 <- plot_grid(figure_1_1, figure_1_2,
                      labels = NULL, ncol = 1
)

# ggsave(file.path(envrmt$path_figures, "figure_cntry_avg.png"), plot = figure_cntry_avg,
#        width = 216, height = 279, units = "mm", dpi = 300)
# ggsave(file.path(envrmt$path_figures, "figure_cntry_avg_res.png"), plot = figure_cntry_avg_res,
#        width = 216, height = 279, units = "mm", dpi = 300)
# ggsave(file.path(envrmt$path_figures, "map_covid_infections.png"), plot = map_covid_infections,
#        width = 279, height = 216, units = "mm", dpi = 300)
# ggsave(file.path(envrmt$path_figures, "map_pm_median.png"), plot = map_pm_median,
#        width = 279, height = 216, units = "mm", dpi = 300)

ggsave(file.path(envrmt$path_figures, "figure_1.png"),
       plot = figure_1,
       width = 216, height = 279, units = "mm", dpi = 300
)



pdf(NULL, width = 5, height = 10)
dev.control(displaylist = "enable")
plot(rd, type = "points", scaling = 0)
figure_rda <- recordPlot()
invisible(dev.off())

figure_2_1 <- plot_grid(figure_effectsize, figure_rda,
                        labels = c("a", "b"), label_size = 10,
                        rel_widths = c(1, 2)
)

figure_2_2 <- plot_grid(map_rda1_score, map_t_sig,
                        labels = c("c", "d"), label_size = 10, ncol = 2
)

figure_2 <- plot_grid(figure_2_1, figure_2_2,
                      labels = NULL, ncol = 1
)


# ggsave(file.path(envrmt$path_figures, "figure_effectsize.png"), plot = figure_effectsize,
#        width = 216, height = 279, units = "mm", dpi = 300)
# figure_rda_tmp = plot_grid(figure_rda, labels = "")
#
# ggsave(file.path(envrmt$path_figures, "figure_rda.png"), plot = figure_rda_tmp,
#        width = 279, height = 216, units = "mm", dpi = 300)
# ggsave(file.path(envrmt$path_figures, "map_rda1_score.png"), plot = map_rda1_score,
#        width = 279, height = 216, units = "mm", dpi = 300)
# ggsave(file.path(envrmt$path_figures, "map_t_sig.png"), plot = map_t_sig,
#        width = 279, height = 216, units = "mm", dpi = 300)


ggsave(file.path(envrmt$path_figures, "figure_2.png"),
       plot = figure_2,
       width = 216, height = 279, units = "mm", dpi = 300
)
```






# Dynmiac time warp clustering on countrywide average
```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = TRUE}
mapview(cmpldata$de_clstr$clstr_map, zcol = "cluster_covid")
mapview(cmpldata$de_clstr$clstr_map, zcol = "cluster_pm")
```

```{r, eval = TRUE, echo=FALSE, warning=FALSE, message=FALSE}
de_clstr <- cmpldata$de_clstr

clstr_avg_pm_gam_time <- de_clstr$clstr_avg_pm[
  de_clstr$clstr_avg_pm$date >= as.POSIXct("2020-02-15") &
    de_clstr$clstr_avg_pm$date <= as.POSIXct("2020-04-01"),
  ]
clstr_avg_pm_gam_time$weekday <- weekdays(clstr_avg_pm_gam_time$date)
clstr_avg_pm_gam_time$predicted <- NA
clstr_avg_pm_gam_time$residuals <- NA


for (c in unique(clstr_avg_pm_gam_time$cluster_pm)) {
  set.seed(01042020)
  gam_time <- gam(new_cases ~ s(seq(length(date))) + weekday,
                  family = quasipoisson,
                  data = clstr_avg_pm_gam_time[clstr_avg_pm_gam_time$cluster_pm == c, ]
  )
  clstr_avg_pm_gam_time[clstr_avg_pm_gam_time$cluster_pm == c, "predicted"] <- predict(gam_time, type = "response")
  clstr_avg_pm_gam_time[clstr_avg_pm_gam_time$cluster_pm == c, "residuals"] <- residuals(gam_time, type = "response")
}

clstr_avg_covid_gam_time <- de_clstr$clstr_avg_covid[
  de_clstr$clstr_avg_covid$date >= as.POSIXct("2020-02-15") &
    de_clstr$clstr_avg_covid$date <= as.POSIXct("2020-04-01"),
  ]
clstr_avg_covid_gam_time$weekday <- weekdays(clstr_avg_covid_gam_time$date)
clstr_avg_covid_gam_time$predicted <- NA
clstr_avg_covid_gam_time$residuals <- NA

for (c in unique(clstr_avg_covid_gam_time$cluster_covid)) {
  set.seed(01042020)
  gam_time <- gam(new_cases ~ s(seq(length(date))) + weekday,
                  family = quasipoisson,
                  data = clstr_avg_covid_gam_time[clstr_avg_covid_gam_time$cluster_covid == c, ]
  )
  clstr_avg_covid_gam_time[clstr_avg_covid_gam_time$cluster_covid == c, "predicted"] <- predict(gam_time, type = "response")
  clstr_avg_covid_gam_time[clstr_avg_covid_gam_time$cluster_covid == c, "residuals"] <- residuals(gam_time, type = "response")
}

ggplot() +
  geom_line(data = clstr_avg_pm_gam_time, aes(x = date, y = pm_median, color = "Daily median PM10")) +
  geom_line(data = clstr_avg_pm_gam_time, aes(x = date, y = new_cases, color = "Daily new cases")) +
  geom_line(data = clstr_avg_pm_gam_time, aes(x = date, y = predicted, color = "Daily new cases, explained by time")) +
  geom_vline(xintercept = as.POSIXct("2020-03-14"), linetype = "dotted", color = "black") +
  geom_vline(xintercept = as.POSIXct("2020-03-17"), linetype = "dotted", color = "black") +
  labs(x = "Date and day of week", y = bquote("Infections, PM10 " ~ µm / m^3)) +
  theme_bw() +
  scale_x_datetime(date_labels = "%d.%m, %a", date_breaks = "5 day", date_minor_breaks = "1 day") +
  scale_color_manual(values = c("#b2df8a", "#1f78b4", "#a6cee3")) +
  theme(
    text = element_text(size = 10), axis.title = element_text(size = 10),
    axis.text.x = element_text(angle = 90, hjust = 0.95, vjust = 0.2),
    legend.title = element_blank(), panel.background = element_blank(),
    panel.grid.major = element_blank(), panel.grid.minor = element_blank()
  ) +
  facet_wrap(~cluster_pm, ncol = 2, nrow = 6, scales = "fix")

ggplot() +
  geom_line(data = clstr_avg_covid_gam_time, aes(x = date, y = pm_median, color = "Daily median PM10")) +
  geom_line(data = clstr_avg_covid_gam_time, aes(x = date, y = new_cases, color = "Daily new cases")) +
  geom_line(data = clstr_avg_covid_gam_time, aes(x = date, y = predicted, color = "Daily new cases, explained by time")) +
  geom_vline(xintercept = as.POSIXct("2020-03-14"), linetype = "dotted", color = "black") +
  geom_vline(xintercept = as.POSIXct("2020-03-17"), linetype = "dotted", color = "black") +
  labs(x = "Date and day of week", y = bquote("Infections, PM10 " ~ µm / m^3)) +
  theme_bw() +
  scale_x_datetime(date_labels = "%d.%m, %a", date_breaks = "5 day", date_minor_breaks = "1 day") +
  scale_color_manual(values = c("#b2df8a", "#1f78b4", "#a6cee3")) +
  theme(
    text = element_text(size = 10), axis.title = element_text(size = 10),
    axis.text.x = element_text(angle = 90, hjust = 0.95, vjust = 0.2),
    legend.title = element_blank(), panel.background = element_blank(),
    panel.grid.major = element_blank(), panel.grid.minor = element_blank()
  ) +
  facet_wrap(~cluster_covid, ncol = 2, nrow = 6, scales = "fix")
```



```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
de_clstr <- cmpldata$de_clstr$clstr
# pdata = compilePopulation()
# de_clstr = merge(de_clstr, pdata, by = "nuts3Code")
#
# de_clstr = merge(de_clstr, st_set_geometry(cmpldata$de_nuts3_map[, c("nuts3Code", "nuts3Name", "centroid_lat", "centroid_lon", "nuts3Area")], NULL), by.x = "nuts3Code", by.y = "nuts3Code")
#
# de_clstr$nuts3Area = as.numeric(de_clstr$nuts3Area)
# de_clstr$cases_per_area = de_clstr$cases / de_clstr$nuts3Area
# de_clstr$cases_per_pop = de_clstr$cases / de_clstr$pop_total
# de_clstr$cases_per_pop_dens = de_clstr$cases / de_clstr$pop_dens
# de_clstr$new_cases_per_area = de_clstr$new_cases / de_clstr$nuts3Area
# de_clstr$new_cases_per_pop = de_clstr$new_cases / de_clstr$pop_total
# de_clstr$new_cases_per_pop_dens = de_clstr$new_cases / de_clstr$pop_dens
# de_clstr$pm_mean_dt = c(0, diff(de_clstr$pm_mean))
# de_clstr$weekday_cn = as.numeric(de_clstr$weekday_c)
# de_clstr$days_before_shutdown = difftime(de_clstr$date, as.POSIXct("2020-03-17"), units = "days")


info <- lapply(unique(de_clstr$nuts3Code), function(n) {
  tmp <- de_clstr[de_clstr$nuts3Code == n, ]
  tmp$date_numeric <- seq(nrow(tmp))
  
  tmp <- data.frame(
    nuts = tmp$nuts3Code[1],
    date_start = tmp$date[which(tmp$cases > 0)[1]],
    date_max = tmp$date[tail(which(tmp$new_cases == max(tmp$new_cases)), n = 1)],
    daily_max = tmp$new_cases[tail(which(tmp$new_cases == max(tmp$new_cases)), n = 1)],
    cases_at_max = tmp$cases[tail(which(tmp$new_cases == max(tmp$new_cases)), n = 1)]
  )
  
  # set.seed(01042020)
  # # glm_mod = glm(cases ~ date_numeric + I(date_numeric^2),
  # #               family = gaussian,
  # #               data = tmp[tmp$weekday_c == "W" & tmp$date >= date_start,])
  # glm_mod <- zeroinfl(new_cases ~ date_numeric + weekday_c + pm_mean | days_before_shutdown, data = tmp)
  # tmp$cases_pred = 0
  # tmp$cases_pred[tmp$date >= date_start] = predict(glm_mod, tmp[tmp$date >= date_start,])
  # tmp$cases_pred[tmp$cases_pred < 0] = 0
  # plot(tmp$cases_pred)
  # points(tmp$new_cases, col = "red")
  
  return(tmp)
})
info <- do.call("rbind", info)
info$difftime <- difftime(info$date_max, info$date_start, units = "days")
ggplot(data = info, aes(x = difftime)) +
  geom_histogram(binwidth = 5)
summary(as.numeric(info$difftime[info$cases_at_max > 100]))
summary(info$cases_at_max)
summary(info$daily_max)
summary(info$cases_at_max[info$difftime >= 30])
summary(info$cases_at_max)
summary(as.numeric(info$difftime))

head(de_clstr)

ggplot(data = de_clstr[de_clstr$weekday_c == "M", ], aes(x = date, y = new_cases, color = as.factor(nuts3Code))) +
  geom_line() +
  theme(legend.position = "none")

ndays <- c(-14, 35)
ndays <- c(-14, 20)
ndays <- c(0, 30)

gam_lag <- compileLaggedGLM(
  data = de_clstr[de_clstr$nuts3Code %in% info$nuts[info$difftime >= 30 & info$difftime <= 99], ],
  pm = "org",
  frml = "new_cases ~ date + weekday_c + pm_mean_lag",
  nlags = 20,
  subset_var = "new_cases", subset_thv = 1, individual = "start", ndays = c(0, 35)
)

gam_lag <- compileLaggedGAM(
  data = de_clstr,
  pm = "org",
  frml = "new_cases ~ seq(length(date)) + weekday_c + pm_mean_lag",
  nlags = 20,
  subset_var = "new_cases", subset_thv = 1, individual = "start", ndays = c(0, 35)
)



gam_lag <- compileLaggedGLM(
  data = de_clstr,
  pm = "org",
  frml = "new_cases ~ date + weekday_c + pm_mean_lag",
  nlags = 20,
  subset_var = "new_cases", subset_thv = 1, individual = "start", ndays = c(0, 35)
)



gam_lag_geo <- compileLaggedGLMGeo(gam_lag, cmpldata$de_nuts3_map)

t.test(gam_lag$t[gam_lag$lag == -3])

# gam_lag = gam_lag_org
```

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
ggplot(data = gam_lag[abs(gam_lag$t) < 5, ], aes(x = as.factor(lag), y = t)) +
  geom_boxplot() +
  stat_summary(fun.y = mean, geom = "point", shape = 20, size = 5, color = "red", fill = "red") +
  theme_bw() +
  geom_hline(yintercept = c(-2, 2), linetype = "dashed", color = "red") +
  labs(title = paste("Dependence of individual COVID-19 time series and lagged ", pm, " concentrations"), x = "Time lag PM [days]", y = "t value of the partial coefficient")
```

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
ggplot(data = gam_lag[abs(gam_lag$t) < 5, ], aes(x = as.factor(lag), y = t, fill = cluster_pm)) +
  geom_boxplot() +
  theme_bw() +
  geom_hline(yintercept = c(-2, 2), linetype = "dashed", color = "red") +
  labs(title = paste("Dependence of individual COVID-19 time series and lagged ", pm, " concentrations by PM clusters"), x = "Time lag PM [days]", y = "t value of the partial coefficient")
```

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
ggplot(data = gam_lag_geo$test_geo_lag) +
  geom_line(aes(x = lag, y = rsq, color = "R squared")) +
  geom_point(aes(x = lag, y = rsq, color = "R squared")) +
  theme_bw() +
  scale_x_continuous(breaks = seq(-15, 0, 1), minor_breaks = seq(-15, 0, 1)) +
  labs(title = paste("R squared values of lagged ", pm, " concentrations based on latitude, longitude and area", x = "Time lag PM [days]"), y = "R squared", color = "R squared")

ggplot(data = gam_lag_geo$test_geo_lag) +
  geom_line(aes(x = lag, y = centroid_lat_t, color = "latitude")) +
  geom_point(aes(x = lag, y = centroid_lat_t, color = "latitude")) +
  geom_line(aes(x = lag, y = centroid_lon_t, color = "longitude")) +
  geom_point(aes(x = lag, y = centroid_lon_t, color = "longitude")) +
  geom_line(aes(x = lag, y = area_t, color = "log10(area)")) +
  geom_point(aes(x = lag, y = area_t, color = "log10(area)")) +
  theme_bw() +
  geom_hline(yintercept = c(-2, 2), linetype = "dashed", color = "black") +
  scale_x_continuous(breaks = seq(-15, 0, 1), minor_breaks = seq(-15, 0, 1)) +
  scale_y_continuous(breaks = seq(-10, 20, 2)) +
  labs(title = paste("t values of lagged ", pm, " concentrations for latitude, longitude and area"), x = "Time lag PM [days]", y = "t value of the partial coefficient", color = "Partial coefficient")

ggplot(data = gam_lag_geo$test_geo[gam_lag_geo$test_geo$lag == -9, ]) +
  geom_point(aes(x = centroid_lat, y = t, color = as.factor(lag))) +
  theme_bw() +
  geom_hline(yintercept = c(-2, 2), linetype = "dashed", color = "black") +
  scale_x_continuous(breaks = seq(47, 55, 1)) +
  scale_y_continuous(breaks = seq(-10, 20, 2)) +
  labs(title = paste("t values of lagged ", pm, " concentrations for latitude"), x = "Latitude [degrees]", y = "t value of the partial coefficient for PM (glm model)", color = "Lag of PM")

ggplot(data = gam_lag_geo$test_geo[gam_lag_geo$test_geo$lag >= -7 & gam_lag_geo$test_geo$lag <= -4, ]) +
  geom_point(aes(x = centroid_lat, y = t, color = as.factor(lag))) +
  theme_bw() +
  geom_hline(yintercept = c(-2, 2), linetype = "dashed", color = "black") +
  scale_x_continuous(breaks = seq(47, 55, 1)) +
  scale_y_continuous(breaks = seq(-10, 20, 2)) +
  labs(title = paste("t values of lagged ", pm, " concentrations for latitude"), x = "Latitude [degrees]", y = "t value of the partial coefficient for PM (glm model)", color = "Lag of PM")
```

Hier mal ein Versuch, die "Italien-Grafik" aus dem  etwas nachzubauen. Die Signifikanz ist bei PM10 für längere Zeitintervalle gegeben, für PM2.5 praktisch nicht (Setti, L. et al. The Potential role of Particulate Matter in the Spreading of COVID-19 in Northern Italy: First Evidence-based Research Hypotheses. medRxiv, https://www.medrxiv.org/content/10.1101/2020.04.11.20061713v1 (2020).)

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
# 10, 12
test <- cmpldata$de_clstr$clstr[cmpldata$de_clstr$clstr$date < as.POSIXct("2020-03-17"), ] %>%
  group_by(nuts3Code) %>%
  summarize(
    n_days = n(),
    pm_gt_10 = sum(pm_mean > 10),
    pm_gt_10_rel = pm_gt_10 / n_days
  )
test_merge <- merge(test, cmpldata$de_clstr$clstr[cmpldata$de_clstr$clstr$date == as.POSIXct("2020-04-01"), ])
test_merge <- merge(test_merge, st_set_geometry(cmpldata$de_nuts3_map, NULL)[, c("nuts3Code", "area")])
test_merge$ratio <- as.numeric(test_merge$cases / test_merge$area)

ggplot(data = test_merge, aes(x = pm_gt_10, y = ratio)) +
  geom_point() +
  geom_smooth(method = "glm") +
  theme_bw() +
  scale_y_log10() +
  labs(title = paste("COVID-19 infections per province area (01.04.) and days exceeding", pm, " > 10 from 15.2. to 17.03."))
```

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = TRUE}
model <- glm(test_merge$ratio ~ test_merge$pm_gt_10, family = quasipoisson)
summary(model)
```



```{r, eval = FALSE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
# Wavelet coherence analysis

## Wavelet coherence analysis on countrywide average
cntry_avg <- cmpldata$cntry_avg
wc <- compileWC(cntry_avg)

wc.image(wc,
         which.image = "wc",
         n.levels = 250, color.key = "interval",
         siglvl.contour = 0.1, siglvl.arrow = 0.1,
         legend.params = list(lab = "cross-wavelet power levels"), show.date = TRUE,
         spec.period.axis = list(at = seq(15)),
         main = paste("Wavelet coherence cmpldata, ", pm, " x detrended daily COVID-19 cases")
)

# wc.sel.phases(wc, sel.period = 4, siglvl = 1, show.date = TRUE)
```



```{r, eval = FALSE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
## Wavelet coherence analysis on cluster averages
de_clstr <- cmpldata$de_clstr
for (c in unique(de_clstr$clstr_avg_detr$cluster_pm)) {
  tmp <- de_clstr$clstr_avg_detr[de_clstr$clstr_avg_detr$cluster_pm == c, ]
  wc <- compileWC(tmp)
  
  wc.image(wc,
           which.image = "wc",
           n.levels = 250, color.key = "interval",
           siglvl.contour = 0.1, siglvl.arrow = 0.1,
           legend.params = list(lab = "cross-wavelet power levels"), show.date = TRUE,
           spec.period.axis = list(at = seq(15)),
           main = paste("cmpldata, ", pm, " x detrended daily COVID-19 cases, cluster ", c)
  )
  
  # wc.sel.phases(wc, sel.period = 4, siglvl = 1, show.date = TRUE)
}
```

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
cntry_avg_glm_time_03 <- cntry_avg[cntry_avg$date >= as.POSIXct("2020-03-01") & cntry_avg$date <= as.POSIXct("2020-04-20"), ]
set.seed(01042020)
cntry_avg_glm_time <- gam(new_cases ~ s(seq(length(date))) + weekday, family = quasipoisson, data = cntry_avg_glm_time_03)
cntry_avg_glm_time <- glm(new_cases ~ seq(length(date)) + weekday, family = quasipoisson, data = cntry_avg_glm_time_03)
cntry_avg_glm_time_03$predicted <- predict(cntry_avg_glm_time, cntry_avg_glm_time_03, type = "response")
cntry_avg_glm_time_03$residuals <- residuals(cntry_avg_glm_time, type = "response")

figure_01 <- ggplot() +
  geom_line(data = cntry_avg, aes(x = date, y = pm_mean, color = "Daily mean PM10")) +
  geom_point(data = cntry_avg, aes(x = date, y = pm_mean, color = "Daily mean PM10")) +
  geom_line(data = cntry_avg, aes(x = date, y = new_cases, color = "Daily new cases")) +
  geom_point(data = cntry_avg, aes(x = date, y = new_cases, color = "Daily new cases")) +
  geom_line(data = cntry_avg_glm_time_03, aes(x = date, y = predicted, color = "Daily new cases, explained by time")) +
  geom_point(data = cntry_avg_glm_time_03, aes(x = date, y = predicted, color = "Daily new cases, explained by time")) +
  geom_line(data = cntry_avg_glm_time_03, aes(x = date, y = new_cases, color = "Daily new cases")) +
  geom_point(data = cntry_avg_glm_time_03, aes(x = date, y = new_cases, color = "Daily new cases")) +
  geom_vline(xintercept = as.POSIXct("2020-03-14"), linetype = "dotted", color = "black") +
  geom_vline(xintercept = as.POSIXct("2020-03-17"), linetype = "dotted", color = "black") +
  # geom_text(aes(x = as.POSIXct("2020-03-14"), label="Start of contact restrictions \n", y=-1), colour="black", angle=90, size = 3) +
  # geom_text(aes(x = as.POSIXct("2020-03-17"), label="Start of shut down \n", y=-1), colour="black", angle=90, size = 3) +
  labs(x = "Date and day of week", y = expression("Infections, PM10 ~µm/m^{3}")) +
  theme_bw() +
  scale_x_datetime(date_labels = "%d.%m, %a", date_breaks = "2 day", date_minor_breaks = "1 day") +
  scale_color_manual(values = c("#b2df8a", "#1f78b4", "#a6cee3")) +
  theme(
    text = element_text(size = 10), axis.title = element_text(size = 10),
    legend.position = c(0.35, 0.75), axis.text.x = element_text(angle = 90, hjust = 0.95, vjust = 0.2),
    legend.title = element_blank(), panel.background = element_blank(),
    panel.grid.major = element_blank(), panel.grid.minor = element_blank()
  )
figure_01
```




















# Deprecated section from former analysis versions.

## Correlation of PM and SARS-CoV2 infections

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}

gam_lag_mean <- aggregate(gam_lag$t ~ gam_lag$lag, FUN = mean)
gam_lag_sd <- aggregate(gam_lag$t ~ gam_lag$lag, FUN = sd)
colnames(gam_lag_mean) <- c("lag", "t_mean")
colnames(gam_lag_sd) <- c("lag", "t_sd")

gam_lag_mean_sd <- merge(gam_lag_mean, gam_lag_sd)
gam_lag_mean_sd$sig <- NA
gam_lag_mean_sd$sig[match(tstat[tstat$p < 0.1, "lag"], gam_lag_mean_sd$lag)] <-
  gam_lag_mean_sd$t_mean[match(tstat[tstat$p < 0.1, "lag"], gam_lag_mean_sd$lag)]

figure_effectsize_errorbars <- ggplot(data = gam_lag_mean_sd, aes(x = as.factor(lag), y = t_mean)) +
  geom_point() +
  geom_point(aes(x = as.factor(lag), y = sig), color = "red") +
  geom_line() +
  geom_errorbar(aes(ymin = t_mean - t_sd, ymax = t_mean + t_sd)) +
  theme_bw() +
  geom_hline(yintercept = c(0), linetype = "dashed", color = "black") +
  labs(x = "Time lag [days]", y = "Effect size") +
  theme(
    text = element_text(size = 10), axis.title = element_text(size = 10),
    panel.background = element_blank(), panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )
figure_effectsize_errorbars

gam_lag_geo <- compileLaggedGLMGeo(gam_lag, cmpldata$de_nuts3_map)

ggplot(data = gam_lag_geo$test_geo[gam_lag_geo$test_geo$lag == -2, ]) +
  geom_point(aes(x = centroid_lat, y = t, color = as.factor(lag))) +
  theme_bw() +
  geom_hline(yintercept = c(-2, 2), linetype = "dashed", color = "black") +
  scale_x_continuous(breaks = seq(47, 55, 1)) +
  scale_y_continuous(breaks = seq(-10, 20, 2)) +
  labs(
    title = paste("Effect size of lagged ", pm),
    x = "Latitude [degrees]", y = "Effect size", color = "Lag of PM"
  )
```
