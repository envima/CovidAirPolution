---
title: "Correlation of PM2.5 concentrations and SARS-CoV-2 infection"
always_allow_html: true
editor_options:
  chunk_output_type: console
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Set up working environment and defaults --------------------------------------
library(envimaR)
if(Sys.info()[["nodename"]] == "PC19616"){
  source("~/plygrnd/CovidAirPolution/CovidAirPolution/src/functions/000_setup.R")
} else {
  source("~/project/cov/CovidAirPolution/src/functions/000_setup.R")  
}
compile_data = FALSE

start_date = as.POSIXct("2020-02-15")
end_date = as.POSIXct("2020-04-01")
pm = 2.5

# Load Germany -----------------------------------------------------------------
if(compile_data){
  if(pm == 2.5){
    pattern = "DE2020PM2_1SMW_20200421"
    savefile = "germany_025.RDS"
  } else {
    pattern = "DE2020PM1_1SMW_20200421"
    savefile = "germany_100.RDS"
  }
  germany = compileDataDE(start_date = start_date, end_date = end_date,
                          pattern = pattern)
  saveRDS(germany, file.path(envrmt$path_tmp, savefile))
} else {
  germany = readRDS(file.path(envrmt$path_tmp, savefile))
}

```

# Map of NUTS 3 regions with available PM2.5 in

The data is availabe for the following nuts 3 regions.

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = TRUE}
print(paste("Start date for analysis: ", start_date))
print(paste("End date for analysis:   ", end_date))

mapview(germany$de_nuts3_map, zcol = "cases")
```


# Countrywide temporal development of PM2.5 values and COVID-19 cases in Germany

The following figure shows the countrywide average of daily PM2.5 and SARS-CoV-2 infections. Black vertical dotted lines represent the start of the contact restrictions (March 14th) and shut down (March 17th) in Germany.

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
de_avg = germany$de_avg
ggplot() + 
  geom_line(data = de_avg, aes(x = date, y = pm25_mean, color = "PM2.5")) + 
  geom_line(data = de_avg, aes(x = date, y = new_cases, color = "New cases")) + 
  geom_line(data = de_avg, aes(x = date, y = new_cases_smooth, color = "New cases smoothed")) + 
  labs(title = "PM2.5 x daily new Covid-19 cases", x = "Date", y = "Value") +
  geom_vline(xintercept = as.POSIXct("2020-03-14"), linetype="dotted", color = "black") +
  geom_vline(xintercept = as.POSIXct("2020-03-17"), linetype="dotted", color = "black") +
  theme_bw() + 
  scale_x_datetime(date_labels = "%d.%m - %a", date_breaks = "1 day") + 
  scale_color_manual(values=c("red", "blue", "darkgreen")) +
  theme(axis.text.x = element_text(angle=90)) + 
  theme(legend.title = element_blank())
```


Some studies compare the development of atmospheric parameters and COVID-19 cases over the entire avialable time series. As  both air quality and COVID-19 infection rates generally decrease after a shutdown event, at least parts of the identified correlations are likely caused by this external event, especially in regions with a strong influence of local activity on local air quality.

To focus on the corelated development of PM2.5 and COVID-19 infections during the early and exponential growing phase, we restrict the time series to the maximum incubation phase of about 14 days prior the first reported infection and the turning point of the infection dynamics shortly after the absolute maximum which occurs about 14 days after the shutdown data. This sets the date limits from February 15th to April 1st.

For the following figure, smothed daily COVID-19 new infections have been detrended using a quasipoission regression and the time series has been restricted to the afore mentioned time period afterwards.

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
de_avg = germany$de_avg
ggplot() + 
  geom_line(data = de_avg, aes(x = date, y = pm25_mean, color = "PM2.5")) + 
  geom_line(data = de_avg, aes(x = date, y = new_cases_smooth_detr, color = "New cases (smoothed, detrended)")) +
  geom_line(data = de_avg, aes(x = date, y = new_cases_smooth, color = "New cases (smoothed)")) + 
  labs(title = "PM2.5 x daily new Covid-19 cases (smoothed, detrended)", x = "Date", y = "Value") +
  theme_bw() + 
  scale_x_datetime(date_labels = "%d.%m - %a", date_breaks = "1 day") + 
  scale_color_manual(values=c("red", "darkgreen", "blue")) +
  theme(axis.text.x = element_text(angle=90)) + 
  theme(legend.title = element_blank())
```


## Wavelet coherence analysis on countrywide average

Since the dentrended time series is still rather non-stationary and to get a better idea of the time periods and date ranges related to certain time lags, a wavelet coherence analysis is performed with a loess smoother. 

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
de_avg = germany$de_avg
wc = compileWC(de_avg)

wc.image(wc, which.image = "wc",
         n.levels = 250, color.key = "interval",
         siglvl.contour = 0.1, siglvl.arrow = 0.1,
         legend.params = list(lab = "cross-wavelet power levels"), show.date = TRUE,
         spec.period.axis = list(at = seq(15)),
         main = "Wavelet coherence Germany, PM2.5 x detrended daily COVID-19 cases")

# wc.sel.phases(wc, sel.period = 4, siglvl = 1, show.date = TRUE)
```

The analysis shows that for the period of 4 to 6 days, the PM2.5 time series is leading arround March 1 with up to 2 or 3 days (arrows towards right upward). The situation changes towards April 1st. Here the COVID-19 cases are taking over the lead, with a time lag about 25% of the period. The relationship is also inverted mainly as a consequence of the sharp increase in PM2.5 values due to a Sahara dust event.


# Analyis 2: Dynmiac time warp clustering on countrywide average

The map shows clusters (different colors) with similar development of smoothed daily COVID-19 new infections. Cluster ID and number (n) of nuts 3 regions within each cluster is given in the legend.

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = TRUE}
mapview(germany$de_clstr$clstr_map, zcol = "cluster_covid")
mapview(germany$de_clstr$clstr_map, zcol = "cluster_pm25")
```


The plots show the average of daily PM2.5 and smoothed new infections along with their detrened infection series within each cluster. Cluster ID and number (n) of nuts 3 regions within each cluster is given in the figure headers.

```{r, eval = TRUE, echo=FALSE, warning=FALSE, message=FALSE}
de_clstr = germany$de_clstr
ggplot() + 
  geom_line(data = de_clstr$clstr_avg_detr, aes(x = date, y = pm25_mean, color = "PM2.5")) + 
  geom_line(data = de_clstr$clstr_avg_detr, aes(x = date, y = new_cases_smooth, color = "New cases (smoothed)")) + 
  geom_line(data = de_clstr$clstr_avg_detr, aes(x = date, y = new_cases_smooth_detr*5, color = "New cases (smoothed, detrended)")) +
  geom_vline(xintercept = as.POSIXct("2020-03-14"), linetype="dotted", color = "black") +
  geom_vline(xintercept = as.POSIXct("2020-03-17"), linetype="dotted", color = "black") +
  theme_bw() + 
  labs(title = "PM2.5 x daily new Covid-19 cases (smoothed, detrended)", x = "Date", y = "Value") +
  scale_x_datetime(date_labels = "%d.%m - %a", date_breaks = "1 day") + 
  scale_color_manual(values=c("red", "darkgreen", "blue")) +
  theme(axis.text.x = element_text(angle=90)) + 
  theme(legend.title = element_blank()) +
  facet_wrap(~cluster_pm25, ncol =2, nrow = 2, scales = "fix")
```


## Wavelet coherence analysis on cluster averages

The wavelet coherence analysis for each cluster reveals some considerable differences.

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
de_clstr = germany$de_clstr
for(c in unique(de_clstr$clstr_avg_detr$cluster_pm25)){
  tmp = de_clstr$clstr_avg_detr[de_clstr$clstr_avg_detr$cluster_pm25 == c,]
  wc = compileWC(tmp)
  
  wc.image(wc, which.image = "wc",
           n.levels = 250, color.key = "interval",
           siglvl.contour = 0.1, siglvl.arrow = 0.1,
           legend.params = list(lab = "cross-wavelet power levels"), show.date = TRUE,
           spec.period.axis = list(at = seq(15)),
           main = paste("Germany, PM2.5 x detrended daily COVID-19 cases, cluster ", c))
  
  # wc.sel.phases(wc, sel.period = 4, siglvl = 1, show.date = TRUE)
}
```


# Explanatory potential of PM2.5 for COVID-19 cases

## Generalized linear models

We fit generalized linear models with a quasi poission distribution. We used date and PM2.5 as independent variables. To evaluate the lags between PM2.5 and COVID-19 infections, a time lag of up to 14 days has been tested. The date range is again restricted to February 15th to April 1st. To account for delayed testing/reporting over the weekend, weekends and mondays are inclued as factors.

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
de_clstr = germany$de_clstr$clstr
de_model_lag = compileLaggedGLM(de_clstr)
```


Range of t values of the partial coefficient for PM2.5 for each time lag. Negative time lags indicate the leading PM2.5 time series. Red horizontal lines roughly indicate the significance on the 95% level.

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
ggplot(data = de_model_lag, aes(x = as.factor(lag), y = t)) + 
  geom_boxplot() + 
  theme_bw() +
  geom_hline(yintercept = c(-2, 2), linetype="dashed", color = "red") + 
  labs(title = "Dependence of individual COVID-19 time series and lagged PM2.5 concentrations",x = "Time lag PM2.5 [days]", y = "t value of the partial coefficient")
```

As figure above but this time, the partial coefficient for PM2.5 is grouped by the four clusters resulting from the dynmiac time warp clustering. Red horizontal lines roughly indicate the significance on the 95% level.

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
ggplot(data = de_model_lag, aes(x = as.factor(lag), y = t, fill = cluster_pm25)) + 
  geom_boxplot() + 
  theme_bw() + 
  geom_hline(yintercept = c(-2, 2), linetype="dashed", color = "red") + 
  labs(title = "Dependence of individual COVID-19 time series and lagged PM2.5 concentrations by PM2.5 clusters",x = "Time lag PM2.5 [days]", y = "t value of the partial coefficient")
```


The following shows the R squared and t values resulting from a GLM model that relates the t value of the PM2.5 partial coefficient from the model above to latitude, longitude and area.

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
de_model_geo = compileLaggedGLMGeo(de_model_lag, germany$de_nuts3_map)

ggplot(data = de_model_geo$test_geo_lag) + 
  geom_line(aes(x = lag, y = rsq, color = "R squared")) +
  geom_point(aes(x = lag, y = rsq, color = "R squared")) +
  theme_bw() + 
  scale_x_continuous(breaks = seq(-15, 0, 1), minor_breaks = seq(-15, 0, 1)) + 
  labs(title = "R squared values of lagged PM2.5 concentrations based on latitude, longitude and area",x = "Time lag PM2.5 [days]", y = "R squared", color = "R squared")


ggplot(data = de_model_geo$test_geo_lag) + 
  geom_line(aes(x = lag, y = lat_t, color = "latitude")) +
  geom_point(aes(x = lag, y = lat_t, color = "latitude")) +
  geom_line(aes(x = lag, y = lon_t, color = "longitude")) +
  geom_point(aes(x = lag, y = lon_t, color = "longitude")) +
  geom_line(aes(x = lag, y = area_t, color = "log10(area)")) +
  geom_point(aes(x = lag, y = area_t, color = "log10(area)")) +
  theme_bw() + 
  geom_hline(yintercept = c(-2, 2), linetype="dashed", color = "black") + 
  scale_x_continuous(breaks = seq(-15, 0, 1), minor_breaks = seq(-15, 0, 1)) + 
  scale_y_continuous(breaks = seq(-10, 20, 2)) +
  labs(title = "t values of lagged PM2.5 concentrations for latitude, longitude and area",x = "Time lag PM2.5 [days]", y = "t value of the partial coefficient", color = "Partial coefficient")


ggplot(data = de_model_geo$test_geo[de_model_geo$test_geo$lag <= -10,]) + 
  geom_point(aes(x = lat, y = t, color = as.factor(lag))) +
  theme_bw() + 
  geom_hline(yintercept = c(-2, 2), linetype="dashed", color = "black") + 
  scale_x_continuous(breaks = seq(47, 55, 1)) + 
  scale_y_continuous(breaks = seq(-10, 20, 2)) +
  labs(title = "t values of lagged PM2.5 concentrations for latitude",x = "Latitude [degrees]", y = "t value of the partial coefficient for PM2.5 (glm model)", color = "Lag of PM2.5")


ggplot(data = de_model_geo$test_geo[de_model_geo$test_geo$lag >= -7 & de_model_geo$test_geo$lag <= -4,]) + 
  geom_point(aes(x = lat, y = t, color = as.factor(lag))) +
  theme_bw() + 
  geom_hline(yintercept = c(-2, 2), linetype="dashed", color = "black") + 
  scale_x_continuous(breaks = seq(47, 55, 1)) + 
  scale_y_continuous(breaks = seq(-10, 20, 2)) +
  labs(title = "t values of lagged PM2.5 concentrations for latitude",x = "Latitude [degrees]", y = "t value of the partial coefficient for PM2.5 (glm model)", color = "Lag of PM2.5")
```

Hier mal ein Versuch, die Italien-Grafik etwas nachzubauen. Auch hier - nur zufällig signifikant. Achtung - anderes Datum als bei Italien.

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
# 10, 12

test = germany$de_clstr$clstr[germany$de_clstr$clstr$date < as.POSIXct("2020-03-10"),] %>%
  group_by(nuts3Code) %>%
  summarize(n_days = n(),
            pm_gt_10 = sum(pm25_mean > 10),
            pm_gt_10_rel = pm_gt_10 / n_days)
test_merge = merge(test, germany$de_clstr$clstr[germany$de_clstr$clstr$date == as.POSIXct("2020-03-16"),])
test_merge = merge(test_merge, st_set_geometry(germany$de_nuts3_map, NULL)[, c("nuts3Code", "area")])
test_merge$ratio = as.numeric(test_merge$cases/test_merge$area)

ggplot(data = test_merge, aes(x = pm_gt_10, y = ratio)) + 
  geom_point() +
  geom_smooth(method = "glm") +
  theme_bw() + 
  scale_y_log10() +
  labs(title = "COVID-19 infections per province area (16.03.) and days exceeding PM2.5 > 10 from 15.2. to 10.3.")

model = glm(test_merge$ratio ~ test_merge$pm_gt_10, family = quasipoisson)
summary(model)

```
