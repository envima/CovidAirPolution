---
title: "COVID pm 2.5 playground"
output:
  html_document:
    df_print: paged
---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Set up working environment and defaults --------------------------------------
library(envimaR)
if(Sys.info()[["nodename"]] == "PC19616"){
  source("~/plygrnd/CovidAirPolution/CovidAirPolution/src/functions/000_setup.R")
} else {
  source("~/project/CovidAirPolution/src/functions/000_setup.R")  
}
# Load Italy -------------------------------------------------------------------
# italy = compileDataIT()
# saveRDS(italy, file.path(envrmt$path_tmp, "italy.RDS"))
# italy = readRDS(file.path(envrmt$path_tmp, "italy.RDS"))
# nuts3_mean = italy$it_nuts3_mean

# Load Germany -----------------------------------------------------------------
germany = compileDataDE()
saveRDS(germany, file.path(envrmt$path_tmp, "germany.RDS"))
# germany = readRDS(file.path(envrmt$path_tmp, "germany.RDS"))
nuts3_mean = germany$de_nuts3_mean
```


## Übersicht über die verfügbaren Daten zur zeitlichen Entwicklung in Norditalien

Die Abbildung zeigt die räumliche Verteilung der PM 2.5 Messungen.
```{r, eval = TRUE, echo=FALSE, warning=FALSE, message=FALSE}
# mapview(italy$pm_waqi_points$pts, popup = italy$pm_waqi_points$pop, 
#         legend = FALSE, ncol="pm25max")

mapview(germany$pm_uba_points$pts, popup = germany$pm_uba_points$pop, 
        legend = FALSE, ncol="pm25max")
```


```{r eval= FALSE, echo=FALSE, fig.width=10, message=FALSE, warning=FALSE}
#Die Abbildung zeigt die zeitliche Entwicklung der täglich hinzukommenden COVID-19 Fälle in den Provinzen Norditaliens.
# ggplot() + 
#   geom_line(data = cmb, aes(x = date, y = pm25, colour = stat)) + 
#   geom_line(data = cov_lombardia, aes(x = data, y = nuovi_positivi/10)) + 
#   scale_y_continuous(sec.axis = sec_axis(~.*10, name = "New cases")) +
#   geom_line(data = cov_Bergamo, aes(x = data, y = new_cases/10, colour = "Covid Bergamo")) + 
#   scale_y_continuous(sec.axis = sec_axis(~.*10, name = "New cases")) +
#   geom_line(data = cov_Milano, aes(x = data, y = new_cases/10, colour = "Covid Milano")) + 
#   scale_y_continuous(sec.axis = sec_axis(~.*10, name = "New cases"))

fig = plot_ly()
for(l in seq(length(nuts3_mean))){
  fig = fig %>%
    add_trace(data = nuts3_mean[[l]], x = ~date, y = ~new_cases,
              type = 'scatter',
              name = names(nuts3_mean[l]),
              mode = 'lines+markers')
}
fig = fig %>% layout(xaxis = list(title = "Date"),
                     yaxis = list(title = "New cases (daily)"))
fig
```


## Exemplarische Auswertung für die einzelnen Regionen

Die folgenden Abbildungen zeigen jeweils (i) die Zeitreihen PM 2.5 und neuen COVID-Fälle, (ii) die wavelet coherence, (iii) die Phasendifferenz zwischen den periodischen Komponenten (grün = Differenz nahe 0, Gelb-Grün = PM 2.5 früher als COVID, Türkis = Covid früher als PM 2.5, Blau = inverse Zusammenhang, PM 2.5 vor COVID, Rot = inverser Zusammenhang, Covid vor PM 2.5) und (iv) die Übersicht über wichtige Phasen.
```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}

for(l in seq(length(nuts3_mean))){

  # Plot of PM 2.5 and COVID time series
  # fig = plot_ly()
  # fig = fig %>%
  #   add_trace(data = it_nuts3_mean[[l]], x = ~date, y = ~pm25_mean,
  #             name = paste("PM 2.5", names(it_nuts3_mean[l])),
  #             mode = 'lines+markers', line = list(color = "red"), marker = list(color = "red"))
  # 
  # fig = fig %>%
  #   add_trace(data = it_nuts3_mean[[l]], x = ~date, y = ~new_cases,
  #             yaxis = "y2", name = paste("New cases", names(it_nuts3_mean[l])),
  #             mode = 'lines+markers', line = list(color = "blue"), marker = list(color = "blue"))
  # 
  # fig = fig %>% layout(title= names(it_nuts3_mean[l]),
  #                      yaxis = list(title = "PM 2.5 mean"),
  #                      yaxis2 = list(overlaying = "y", side = "right", title = "new cases"))
  # print(fig)
  
  g = ggplot() +
    geom_line(data = nuts3_mean[[l]], aes(x = date, y = pm25_mean, colour  = "PM 2.5 mean")) +
    geom_line(data = nuts3_mean[[l]], aes(x = date, y = new_cases/5, colour  = "New cases")) +
    scale_y_continuous(sec.axis = sec_axis(~.*5, name = "New cases")) +
    labs(title = paste(names(nuts3_mean[l]), " | Average PM2.5 = ", round(mean(nuts3_mean[[l]]$pm25_mean), 2)), x = "Date", y = "PM 25 mean") +
    scale_colour_manual(name = NULL, values = c("blue", "red"))

  print(g)
  
  # Plot of PM 2.5 and COVID wavelet analysis
  wc = analyze.coherency(as.data.frame(nuts3_mean[[l]][, c("date", "pm25_mean", "new_cases")])[, -4],
                         my.pair = c("pm25_mean", "new_cases"),
                         loess.span = 0,
                         dt = 1, dj = 1/100,
                         make.pval = TRUE, n.sim = 100,
                         verbose = FALSE)


  # wc.image(wc, which.image = "wp",
  #        n.levels = 250,
  #        color.key = "interval",
  #        siglvl.contour = 0.1, siglvl.arrow = 0.1,
  #        legend.params = list(lab = "cross-wavelet power levels"),
  #        show.date = TRUE, main = paste("Cross-wavelet power", names(it_nuts3_mean[l])))
  #
  # wc.avg(wc, which.avg = "wp", exponent = 1,
  #        main = paste("Main frequencies of cross-wavelet power", names(it_nuts3_mean[l])))

  wc.image(wc, which.image = "wc",
           n.levels = 250, color.key = "interval",
           siglvl.contour = 0.1, siglvl.arrow = 0.1,
           legend.params = list(lab = "cross-wavelet power levels"), show.date = TRUE,
           main = paste("Wavelet coherence", names(nuts3_mean[l])))

  wc.phasediff.image(wc, which.contour = "wc",
                     show.date = TRUE,
                     main = paste("Main frequencies of wavelet coherence", names(nuts3_mean[l])))

  wc.avg(wc, which.avg = "wc", exponent = 1, periodlab = "period (days)",
         main = paste("Main frequencies of wavelet coherence", names(nuts3_mean[l])))

}

# https://rpubs.com/ibn_abdullah/rwcoher
# https://bmcpublichealth.biomedcentral.com/articles/10.1186/s12889-019-7607-2
# http://www.hs-stat.com/projects/WaveletComp/WaveletComp_guided_tour.pdf
# https://ehjournal.biomedcentral.com/articles/10.1186/1476-069X-13-102

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

```