---
title: "COVID pm 2.5 playground"
output:
  html_document:
    df_print: paged
---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Set up working environment and defaults --------------------------------------
library(envimaR)
if(Sys.info()[["nodename"]] == "PC19616"){
  source("~/plygrnd/CovidAirPolution/CovidAirPolution/src/functions/000_setup.R")
} else {
  source("~/project/cov/CovidAirPolution/src/functions/000_setup.R")  
}


# Air quality data -------------------------------------------------------------
pm_waqi = makedfWAQI()
# Make SF point vector for map
pm_waqi_points = makeSFPointsWAQI(pm_waqi)


# Covid-19 ---------------------------------------------------------------------
cov_it = getCovidIT()

# Merge air quality and COVID data ---------------------------------------------
cov_it_polygons = makeSFPolygonsItaly(cov_it$cov_nuts3)


# Make SF point vector for map
pm_waqi_points = makeSFPointsWAQI(pm_waqi)


it_nuts3 = st_join(cov_it_polygons, pm_waqi_points$pts)
it_nuts3 = it_nuts3[!is.na(it_nuts3$aq_location), ]

it_nuts3 = lapply(unique(it_nuts3$aq_location), function(l){
  m = merge(it_nuts3,  pm_waqi[[l]], by.x = c("aq_location", "date"), by.y = c("statname", "date"))
  
  m = m[, c("aq_location", "date", "adm1_code", "data", "stato", "codice_regione", 
        "denominazione_regione", "codice_provincia", "denominazione_provincia",
        "sigla_provincia", "lat.x", "long", "totale_casi", "note_it", "note_en",
        "new_cases", "pm25", "pm25_min", "pm25_max")]
})
it_nuts3 = do.call(rbind, it_nuts3)

```

## Räumliche Verteilung der verwendeten Luftqualitätsstationen in Norditalien.
Die Abbildung zeigt die räumliche Verteilung der Stationen und die verwendeten pm25 Datentabellen für die Fallstudie Italien.
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=10}

mapview(pm_waqi_points$pts, popup = pm_waqi_points$pop, legend = FALSE, ncol="pm25max")
```


## Zeitliche Entwicklung in Norditalien
Die Abbildung zeigt die zeitliche Entwicklung der PM 2.5 an drei Stationen sowie die neuen Fälle in der Region Lombardei.

```{r echo=FALSE, fig.width=10, message=FALSE, warning=FALSE}
# ggplot() + 
#   geom_line(data = cmb, aes(x = date, y = pm25, colour = stat)) + 
#   geom_line(data = cov_lombardia, aes(x = data, y = nuovi_positivi/10)) + 
#   scale_y_continuous(sec.axis = sec_axis(~.*10, name = "New cases")) +
#   geom_line(data = cov_Bergamo, aes(x = data, y = new_cases/10, colour = "Covid Bergamo")) + 
#   scale_y_continuous(sec.axis = sec_axis(~.*10, name = "New cases")) +
#   geom_line(data = cov_Milano, aes(x = data, y = new_cases/10, colour = "Covid Milano")) + 
#   scale_y_continuous(sec.axis = sec_axis(~.*10, name = "New cases"))

fig = plot_ly() 

fig = fig %>% add_trace(data = it_nuts3[it_nuts3$denominazione_provincia == "Bergamo",], x = ~date, y = ~new_cases, yaxis = "y2", name = "New cases Bergamo", line=list(color ="red", width = 5, dash = 'dot') ,mode = 'lines+markers')


fig = fig %>% add_trace(data = it_nuts3[it_nuts3$denominazione_provincia == "Milano",], x = ~date, y = ~new_cases, yaxis = "y2", name = "New cases Milano", line = list(color = 'rgb(205, 12, 24)', width = 4, dash = 'dot'),mode = 'lines+markers')

fig = fig %>% layout(yaxis2 = list(overlaying = "y", side = "right", title = "new cases"))

for(l in unique(it_nuts3$aq_location)){
  fig = fig %>% add_trace(data = it_nuts3[it_nuts3$aq_location == l, ], x = ~date, y = ~pm25, type = 'scatter', name = paste("pm 2.5", l), mode = 'lines+markers')
}
fig
```


## Test Bergamo
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=10}
# pm_bergamo = pm_waqi[[8]]
# cov_bergamo = it_nuts3[it_nuts3$denominazione_provincia == "Bergamo",]
# test = merge(pm_bergamo, cov_bergamo, by.x = "date", by.y = "data")
# test$date = as.POSIXct(test$date)

test = it_nuts3[it_nuts3$denominazione_provincia == "Bergamo",]

pm25 = aggregate(test$pm25, by = list(test$date), FUN = mean, na.rm=TRUE)
names(pm25) = c("date", "pm25_mean")

test = merge(pm25, test[seq(nrow(test[test$aq_location == unique(test$aq_location)[1],])), ], by.x = "date", by.y = "date")


# for(i in which(is.na(test$pm25))){
#   test$pm25[i] = mean(test$pm25[i-1], test$pm25[i+1])
# }
# 
# for(i in which(is.na(test$new_cases))){
#   test$new_cases[i] = mean(test$new_cases[i-1], test$new_cases[i+1])
# }


ggplot() + 
  geom_line(data = test, aes(x = date, y = pm25, color = "pm25_mean")) + 
  geom_line(data = test, aes(x = date, y = new_cases/10, color = "Cases")) + 
  scale_y_continuous(sec.axis = sec_axis(~.*10, name = "New cases"))


# Was hat dj für einen Effekt?
test_wc = analyze.coherency(test[, c("date", "pm25_mean", "new_cases")], my.pair = c("pm25_mean", "new_cases"), 
                            loess.span = 0,
                            dt = 1, dj = 1/100,
                            make.pval = TRUE, n.sim = 100)

# wc.image(test_wc, which.image = "wp", 
#          n.levels = 250, 
#          siglvl.contour = 0.1, siglvl.arrow = 0.05,  
#          legend.params = list(lab = "cross-wavelet power levels"), show.date = TRUE)

# Strengere variante - beide Plots zeigen auf die "in phase" im letzten Drittel der Zeitreihe?
wc.image(test_wc, which.image = "wp", 
         n.levels = 250, 
         color.key = "interval", 
         siglvl.contour = 0.1, siglvl.arrow = 0.1, 
         legend.params = list(lab = "cross-wavelet power levels"), show.date = TRUE)


# Das hier identifiziert die wichtigen Frequenzen (der ersten beiden Abbildungen)
wc.avg(test_wc, which.avg = "wp",
       exponent = 1)

# Und waveleght coherence - was machen wir mit diesem Resultat - hier nur dort wo beide signifikant - hier ist der 15. März (siehe ggplot) wahrscheinlich das Dominante.
wc.image(test_wc, which.image = "wc", 
         n.levels = 250, color.key = "interval", 
         siglvl.contour = 0.1, siglvl.arrow = 0.1, 
         legend.params = list(lab = "cross-wavelet power levels"), show.date = TRUE)

# Das hier identifiziert die wichtigen Frequenzen der wavelength coherence
wc.avg(test_wc, which.avg = "wc",
       exponent = 1,
       periodlab = "period (days)")


# Hier mal die Darsetllung, wie die Periode von 7 Tagen sich verhält (hoffe, die 3.5 sind richtig...)
# wc.sel.phases(test_wc, sel.period = 7, siglvl = 1, only.coi = TRUE)

at.ph = seq(-pi, pi, by = pi/3.5)
labels.ph = seq(-3.5, 3.5, by = 1)
at.t = seq(from = as.POSIXct("2016-10-31 00:00:00", tz = "EST5EDT"),
           to = as.POSIXct("2016-11-06 00:00:00", tz = "EST5EDT"), by = "days")
at.t = test[, c("date")]
labels.t  =  format(at.t, format = "%a")
wc.sel.phases(test_wc, sel.period = 7, 
              siglvl = 1, 
              spec.phase.axis = list(at = at.ph, labels = labels.ph), 
              timelab = "", phaselab = "phase (days)",
              show.date = TRUE,  
              spec.time.axis = list(at = at.t, labels = labels.t),only.coi = TRUE)
abline(h = 0)

# https://rpubs.com/ibn_abdullah/rwcoher

# https://bmcpublichealth.biomedcentral.com/articles/10.1186/s12889-019-7607-2

```

Der Verlauf der Station Bergamo-Via-Meucci gegen die neuen Corona Fälle in Bergamo
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=10}

# http://www.hs-stat.com/projects/WaveletComp/WaveletComp_guided_tour.pdf
# https://ehjournal.biomedcentral.com/articles/10.1186/1476-069X-13-102

# merge data colums
pm_bergamo = pm_waqi[[8]]
cov_bergamo = it_nuts3[it_nuts3$denominazione_provincia == "Bergamo",]
bergamo = merge(pm_bergamo, cov_bergamo, by.x = "date", by.y = "data")
bergamo$data = as.POSIXct(bergamo$date)
ggplot() + 
  geom_line(data = test, aes(x = date, y = pm25, color = "pm25")) + 
  geom_line(data = test, aes(x = date, y = new_cases/10, color = "Cases")) + 
  scale_y_continuous(sec.axis = sec_axis(~.*10, name = "New cases"))
```


Die nachfolgenden Abbildung zeigen die wavelet Analyse der Periodizität neuen Corona Fälle und des pm25 in Bergamo
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=10}
# convert date to factor
#bergamo$data = as.factor(as.character(bergamo$data))

# new_cases only is there a periodicy?
par(mar = c(4, 4, 0.1, 0.1))
bergamo.w  =  analyze.wavelet(bergamo, "new_cases",
                              loess.span = 0,dt = 1, dj = 1/50,
                              lowerPeriod = 1, upperPeriod = 14, make.pval = TRUE, 
                              n.sim = 10)

wt.image(bergamo.w, color.key = "interval", n.levels = 250,
         legend.params = list(lab = "wavelet power levels"),
         periodlab = "period (days)",label.time.axis = TRUE, 
         show.date = TRUE, date.format = "%m%d")


# pm25 only is there a periodicy?
bergamo.w  =  analyze.wavelet(bergamo, "pm25",
                              loess.span = 0,dt = 1, dj = 1/50,
                              lowerPeriod = 1, upperPeriod = 14, make.pval = TRUE, 
                              n.sim = 20)

wt.image(bergamo.w, color.key = "interval", n.levels = 250,
         legend.params = list(lab = "wavelet power levels"),
         periodlab = "period (days)",label.time.axis = TRUE, 
         show.date = TRUE, date.format = "%m%d")

