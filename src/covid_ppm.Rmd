---
title: "COVID pm 2.5 playground"
output:
  html_document:
    df_print: paged
---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Set up working environment and defaults --------------------------------------
library(envimaR)
root_folder = path.expand("~/plygrnd/CovidAirPolution/")
source(file.path(root_folder, "CovidAirPolution/src/functions/000_setup.R"))


# Air quality data -------------------------------------------------------------
#flist = Sys.glob(file.path(envrmt$`path_report-data-platform-16229-259611-lombardy`,"*.csv"))
flist = list.files(
  file.path(envrmt$`path_report-data-platform-16229-259611-lombardy`), 
  pattern = "^.*\\.csv$", full.names = TRUE)

pm_waqi = sfWAQI(flist)



# Covid-19 ---------------------------------------------------------------------
cov_it = getCovidIT()
```


Die Abbildung zeigt die räumliche Verteilung der Stationen für die Fallstudie Italien.
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=10}
mapview(pm_waqi, zcol = "pm25")
```

Die Abbildung zeigt die zeitliche Entwicklung der PM 2.5 an drei Stationen sowie die neuen Fälle in der Region Lombardei.
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=10}
# ggplot() + 
#   geom_line(data = cmb, aes(x = date, y = pm25, colour = stat)) + 
#   geom_line(data = cov_lombardia, aes(x = data, y = nuovi_positivi/10)) + 
#   scale_y_continuous(sec.axis = sec_axis(~.*10, name = "New cases")) +
#   geom_line(data = cov_Bergamo, aes(x = data, y = new_cases/10, colour = "Covid Bergamo")) + 
#   scale_y_continuous(sec.axis = sec_axis(~.*10, name = "New cases")) +
#   geom_line(data = cov_Milano, aes(x = data, y = new_cases/10, colour = "Covid Milano")) + 
#   scale_y_continuous(sec.axis = sec_axis(~.*10, name = "New cases"))

# fig = plot_ly() 
# for(l in seq_along(aq)){
#   
#   fig = fig %>% add_trace(data = aq[[l]][[1]], x = ~date, y = ~pm25, type = 'scatter', name = paste("pm 2.5", names(aq[1])), mode = 'lines+markers')
#   
# }

fig = plot_ly() %>% 
  add_trace(data = pm_waqi, x = ~date, y = ~pm25, color = ~statname, 
            type = 'scatter', mode = 'lines+markers')

fig = fig %>% 
  add_trace(
    data = cov_it$cov_admin3[cov_it$cov_admin3$denominazione_provincia == "Bergamo",], 
    x = ~data, y = ~new_cases, yaxis = "y2", name = "New cases Bergamo", 
    mode = 'lines+markers')

fig = fig %>% 
  add_trace(
    data = cov_it$cov_admin3[cov_it$cov_admin3$denominazione_provincia == "Milano",], 
            x = ~data, y = ~new_cases, yaxis = "y2", name = "New cases Milano", 
            mode = 'lines+markers')

fig = fig %>% 
  layout(yaxis2 = list(overlaying = "y", side = "right", title = "new cases"))

fig
```

