---
title: "COVID pm 2.5 playground"
always_allow_html: true
editor_options:
  chunk_output_type: console
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Set up working environment and defaults --------------------------------------
library(envimaR)
if(Sys.info()[["nodename"]] == "PC19616"){
  source("~/plygrnd/CovidAirPolution/CovidAirPolution/src/functions/000_setup.R")
} else {
  source("~/project/cov/CovidAirPolution/src/functions/000_setup.R")  
}
# Load Italy -------------------------------------------------------------------
# italy = compileDataIT()
# saveRDS(italy, file.path(envrmt$path_tmp, "italy.RDS"))
# italy = readRDS(file.path(envrmt$path_tmp, "italy.RDS"))
# nuts3_mean = italy$it_nuts3_mean

# Load Germany -----------------------------------------------------------------
# germany = compileDataDE()
# saveRDS(germany, file.path(envrmt$path_tmp, "germany.RDS"))
germany = readRDS(file.path(envrmt$path_tmp, "germany.RDS"))
nuts3_mean = germany$de_nuts3_mean
```


## Data and Methods
Raw data on PM2.5 has been provided by the German environmental protection agency (UBN). ...

Data on total daily COVID-19 cases and deaths has been provided by the Robert-Koch-Institut. The data has been smoothed using a gaussian loess function with span 0.3 to reduce variation due to delayed reporting over the weekend and especcially on Sunday and Monday. The daily number of new infections has been computed from the daily variations of the total confirmed numbers.


## Overview of the mean development of PM2.5 and COVID-19 cases in Germany

The following figure shows the country wide average of daily PM2.5 and new, smoothed COVID-19 cases. Black vertical dotted lines represent the start of the contact restrictions (March 14th) and shut down (March 17th).

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
de_avg = lapply(nuts3_mean, 
                "[", c("date", "date_day", "pm25_mean", "new_cases", 
                       "new_cases_smooth", "cases_smooth", 
                       "deaths_smooth", "new_deaths", "new_deaths_smooth"))
de_avg = do.call("rbind", de_avg)
de_avg = as.data.frame(de_avg)[, -ncol(de_avg)]
de_avg = de_avg[de_avg$date >= as.POSIXct("2020-02-15", tz = "CET"), ]

de_avg = aggregate(. ~ date, data = de_avg, FUN = mean)
de_avg$date_day = paste(de_avg$date, substr(weekdays(de_avg$date), 1, 1))

ggplot() + 
  geom_line(data = de_avg, aes(x = date, y = pm25_mean, color = "PM2.5")) + 
  geom_line(data = de_avg, aes(x = date, y = new_cases_smooth, color = "New cases (smoothed)")) + 
  labs(title = "PM2.5 x daily new Covid-19 cases (smoothed)", x = "Date", y = "Value") +
  scale_x_datetime(date_labels = "%d.%m - %a", date_breaks = "1 day") + 
  scale_color_manual(values=c("red", "blue")) +
  theme(axis.text.x = element_text(angle=90)) + 
  geom_vline(xintercept = as.POSIXct("2020-03-14"), linetype="dotted", color = "black") +
  geom_vline(xintercept = as.POSIXct("2020-03-17"), linetype="dotted", color = "black") +
  theme(legend.title = element_blank())
```


## Dependency between development of PM2.5 and COVID-19 cases in Germany

Some studies compare the development of atmospheric parameters and COVID-19 cases over the entire avialable time series. As  both air quality and COVID-19 rates generally decrease after a shutdown event, at least parts of the identified correlations are likely caused by this external event, especially in regions with a strong influence of local activity on local air quality.

To focus on the corelated development of PM2.5 and COVID-19 cases during the early and exponential growing phase, we restrict the time series to the maximum incubation phase of 14 days prior the first reported infection and the turning point of the infection dynamics shortly after the absolute maximum. For the following figure, the time series has been restricted to this period and the daily new, smothed COVID-19 cases have been detrended using a poission regression.

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
new_cases_smooth_detr = glm(new_cases_smooth ~ date,  family = poisson, data =de_avg)
new_cases_smooth_detr = residuals(new_cases_smooth_detr)
de_avg$new_cases_smooth_detr = new_cases_smooth_detr


de_avg = de_avg[
  de_avg$date >= as.POSIXct("2020-02-15 CET") & 
    de_avg$date <= as.POSIXct("2020-04-01 CEST"), ]

# new_cases_smooth_detr = glm(new_cases_smooth ~ date,  family = poisson, data =de_avg)
# new_cases_smooth_detr = residuals(new_cases_smooth_detr)
# de_avg$new_cases_smooth_detr = new_cases_smooth_detr

# summary(gam(new_cases_smooth ~ lag(pm25_mean, 6),  family = quasipoisson, data =de_avg))
# summary(gam(new_cases_smooth_detr ~ lead(pm25_mean, 6),  family = gaussian, data =de_avg))
# summary(gam(de_avg$new_cases_smooth[7:47] ~ de_avg$pm25_mean[1:41],  family = poisson))

ggplot() + 
  geom_line(data = de_avg, aes(x = date, y = pm25_mean, color = "PM2.5")) + 
  geom_line(data = de_avg, aes(x = date, y = new_cases_smooth_detr, color = "New cases (smoothed, detrended)")) +
  geom_line(data = de_avg, aes(x = date, y = new_cases_smooth, color = "New cases (smoothed)")) + 
  labs(title = "PM2.5 x daily new Covid-19 cases (smoothed, detrended)", x = "Date", y = "Value") +
  scale_x_datetime(date_labels = "%d.%m - %a", date_breaks = "1 day") + 
  scale_color_manual(values=c("red", "darkgreen", "blue")) +
  theme(axis.text.x = element_text(angle=90)) + 
  geom_vline(xintercept = as.POSIXct("2020-03-14"), linetype="dotted", color = "black") +
  geom_vline(xintercept = as.POSIXct("2020-03-17"), linetype="dotted", color = "black") +
  theme(legend.title = element_blank())
```

Based on that, the cross-correlation between PM2.5 and detrended daily new COVID-19 cases shows that PM2.5 is both leading up to 6 days and lagging up to 9 days. 

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
ccf(de_avg$pm25_mean, de_avg$new_cases_smooth_detr,
    main = "PM2.5 x Smothed daily new COVID-19 cases")
```


Since the dentrended time series is still rather non-stationary and to get a better idea of the time periods and date ranges related to certain time lags, a wavelet coherence analysis is performed with a loess smoother. 

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
set.seed(01042020)
wc = analyze.coherency(de_avg,
                       my.pair = c("pm25_mean", "new_cases_smooth_detr"),
                       loess.span = 0.33,
                       dt = 1, dj = 1/12,
                       window.type.t = "bar", window.type.s = "bar",
                       window.size.t = 14, window.size.s = 1/4,
                       make.pval = TRUE, method = "white.noise",
                       n.sim = 100,
                       verbose = FALSE)

wc.image(wc, which.image = "wc",
         n.levels = 250, color.key = "interval",
         siglvl.contour = 0.1, siglvl.arrow = 0.1,
         legend.params = list(lab = "cross-wavelet power levels"), show.date = TRUE,
         spec.period.axis = list(at = seq(15)),
         main = "Wavelet coherence Germany, PM2.5 x detrended daily COVID-19 cases")

# wc.sel.phases(wc, sel.period = 4, siglvl = 1, show.date = TRUE)
```

The analysis shows that for the period of 4 to 5 days, the PM2.5 time series is leading arround March 1 with up to 2 or 3 days (arrows towards right upward). The situation changes towards April 1st. Here the COVID-19 cases are taking over the lead, with a small time lag at the period of arround 4 days and a lag of about 2 or 3 days at a period of about 8 days.


## Dynmiac time warp clusters

The following figure shows clusters with similar development of daily COVID-19 cases.

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
new_cases = lapply(nuts3_mean, function(n){
  as.data.frame(n[, "new_cases_smooth"])[, -2]
})

new_cases_dtw_cluster = tsclust(new_cases, type = "partitional", k = 4,
                                distance = "dtw_basic", centroid = "pam", seed=01042020, 
                                trace = TRUE,
                                args = tsclust_args(dist = list(window.size = 10)))

plot(new_cases_dtw_cluster, type = "c")

# cluster = lapply(seq(length(nuts3_mean)), function(r){
#   data.frame(nuts3 = names(nuts3_mean[r]),
#              cluster = new_cases_dtw_cluster@cluster[r],
#              pm25_mean =  mean(nuts3_mean[[r]]$pm25_mean),
#              covid_cases  = mean(nuts3_mean[[r]]$new_cases_smooth),
#              var = c("mean PM2.5 x mean new covid cases"))
# })
# 
# cluster = do.call("rbind", cluster)
# 
# ggplot(data =cluster, aes(x = pm25_mean, y = covid_cases)) +
#   geom_point() +
#   geom_smooth() +
#   labs(title = "Overivew PM2.5 x Covid-19 cases", x = "PM 2.5", y = "Covid-19 cases") +
#   facet_wrap(~cluster, ncol =2, nrow = 2, scales = "free")
```

The average of daily PM2.5 and smoothed new COVID-19 cases along with their detrened series within each cluster is shown in the figure below.

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
de_clstr = lapply(seq(length(nuts3_mean)), function(c){
  tmp = nuts3_mean[[c]][, c("date", "pm25_mean", "nuts3Code", "new_cases", 
                            "new_cases_smooth", "cases_smooth", 
                            "deaths_smooth", "new_deaths", "new_deaths_smooth")]
  tmp$cluster = as.factor(paste0("c ", new_cases_dtw_cluster@cluster[c], " n=(", 
                                 new_cases_dtw_cluster@clusinfo[new_cases_dtw_cluster@cluster[c], 1],
                                 ")"))
  return(tmp)
})

de_clstr = do.call("rbind", de_clstr)
de_clstr = as.data.frame(de_clstr)[, -ncol(de_clstr)]
de_clstr = de_clstr[de_clstr$date >= as.POSIXct("2020-02-15", tz = "CET"), ]
de_clstr$cluster = factor(de_clstr$cluster, levels = sort(unique(as.character(de_clstr$cluster))))

de_clstr_avg = de_clstr[, -which(names(de_clstr) == "nuts3Code")]
de_clstr_avg = aggregate(. ~ date + cluster, data = de_clstr_avg, FUN = mean)
de_clstr_avg$date_day = paste(de_clstr_avg$date, substr(weekdays(de_clstr_avg$date), 1, 1))

# ggplot() + 
#   geom_line(data = de_clstr_avg, aes(x = date, y = pm25_mean, color = "PM2.5")) + 
#   geom_line(data = de_clstr_avg, aes(x = date, y = new_cases_smooth, color = "New cases (smoothed)")) + 
#   labs(title = "PM2.5 x daily new Covid-19 cases (smoothed) by cluster", x = "Date", y = "Value") +
#   scale_x_datetime(date_labels = "%d.%m - %a", date_breaks = "1 day") + 
#   scale_color_manual(values=c("red", "blue")) +
#   theme(axis.text.x = element_text(angle=90)) + 
#   geom_vline(xintercept = as.POSIXct("2020-03-14"), linetype="dotted", color = "black") +
#   geom_vline(xintercept = as.POSIXct("2020-03-17"), linetype="dotted", color = "black") +
#   facet_wrap(~cluster, ncol =2, nrow = 2, scales = "free")


de_clstr_avg_detr = lapply(unique(de_clstr_avg$cluster), function(c){
  tmp = de_clstr_avg[de_clstr_avg$cluster == c,]
  detr = glm(new_cases_smooth ~ date,  family = poisson, data =tmp)
  de_clstr_avg[de_clstr_avg$cluster == c, "new_cases_smooth_detr"] = residuals(detr)
  return(de_clstr_avg[de_clstr_avg$cluster == c,])
})
de_clstr_avg_detr = do.call("rbind", de_clstr_avg_detr)

de_clstr_avg_detr = de_clstr_avg_detr[
  de_clstr_avg_detr$date >= as.POSIXct("2020-02-15 CET") & 
    de_clstr_avg_detr$date <= as.POSIXct("2020-04-01 CEST"), ]

# new_cases_smooth_detr = glm(new_cases_smooth ~ date,  family = poisson, data =de_clstr_avg)
# new_cases_smooth_detr = residuals(new_cases_smooth_detr)
# de_clstr_avg$new_cases_smooth_detr = new_cases_smooth_detr

# summary(gam(new_cases_smooth ~ lag(pm25_mean, 6),  family = quasipoisson, data =de_clstr_avg))
# summary(gam(new_cases_smooth_detr ~ lead(pm25_mean, 6),  family = gaussian, data =de_clstr_avg))
# summary(gam(de_clstr_avg$new_cases_smooth[7:47] ~ de_clstr_avg$pm25_mean[1:41],  family = poisson))

ggplot() + 
  geom_line(data = de_clstr_avg_detr, aes(x = date, y = pm25_mean, color = "PM2.5")) + 
  geom_line(data = de_clstr_avg_detr, aes(x = date, y = new_cases_smooth_detr, color = "New cases (smoothed, detrended)")) +
  geom_line(data = de_clstr_avg_detr, aes(x = date, y = new_cases_smooth, color = "New cases (smoothed)")) + 
  labs(title = "PM2.5 x daily new Covid-19 cases (smoothed, detrended)", x = "Date", y = "Value") +
  scale_x_datetime(date_labels = "%d.%m - %a", date_breaks = "1 day") + 
  scale_color_manual(values=c("red", "darkgreen", "blue")) +
  theme(axis.text.x = element_text(angle=90)) + 
  geom_vline(xintercept = as.POSIXct("2020-03-14"), linetype="dotted", color = "black") +
  geom_vline(xintercept = as.POSIXct("2020-03-17"), linetype="dotted", color = "black") +
  theme(legend.title = element_blank()) +
  facet_wrap(~cluster, ncol =2, nrow = 2, scales = "free")
```


Based on that, the cross-correlation between PM2.5 and detrended daily new COVID-19 cases per cluster is shown below. 
```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
for(c in unique(de_clstr_avg$cluster)){
  ccf(de_clstr_avg_detr[de_clstr_avg_detr$cluster == c, "pm25_mean"], 
      de_clstr_avg_detr[de_clstr_avg_detr$cluster == c, "new_cases_smooth_detr"],
      main = paste("PM2.5 x Smothed daily new COVID-19 cases, cluster ", c))
}
```


Finaly, the following figures show the wavelet coherence analysis per cluster.
```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
for(c in unique(de_clstr_avg$cluster)){
  tmp = de_clstr_avg_detr[de_clstr_avg_detr$cluster == c,]
  set.seed(01042020)
  wc = analyze.coherency(tmp,
                         my.pair = c("pm25_mean", "new_cases_smooth_detr"),
                         loess.span = 0.33,
                         dt = 1, dj = 1/12,
                         window.type.t = "bar", window.type.s = "bar",
                         window.size.t = 14, window.size.s = 1/4,
                         make.pval = TRUE, method = "white.noise",
                         n.sim = 100, verbose = FALSE)
  
  wc.image(wc, which.image = "wc",
           n.levels = 250, color.key = "interval",
           siglvl.contour = 0.1, siglvl.arrow = 0.1,
           legend.params = list(lab = "cross-wavelet power levels"), show.date = TRUE,
           spec.period.axis = list(at = seq(15)),
           main = paste("Germany, PM2.5 x detrended daily COVID-19 cases, cluster ", c))
  
  # wc.sel.phases(wc, sel.period = 4, siglvl = 1, show.date = TRUE)
}
```

## Explanatory power of PM2.5 for COVID-19 cases

The following gam model indicates the predictive power of PM2.5 for the German cases.
```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
cl <- makePSOCKcluster(5)
registerDoParallel(cl)

de_clstr_ap = de_clstr[de_clstr$date >= as.POSIXct("2020-02-15 CET") & 
    de_clstr$date <= as.POSIXct("2020-04-01 CEST"), ]

set.seed(01042020)
fold = groupKFold(de_clstr_ap$nuts3Code, k = 30)


fitControl <- trainControl(method = "cv",
                           index = fold)

set.seed(01042020)
de_clstr_gam <- train(new_cases_smooth ~ pm25_mean, data = de_clstr_ap, 
                      method = "gam", family = poisson, 
                      trControl = fitControl,
                      ## This last option is actually one
                      ## for gbm() that passes through
                      verbose = FALSE)
stopCluster(cl)

print(summary(de_clstr_gam))
```


The following gam models indicate the predictive power of PM2.5 within the individual German clusters The internal cross validation error is based on a 10-fold leave region out cross-validation.
```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = FALSE}
cl <- makePSOCKcluster(4)
registerDoParallel(cl)

de_clstr_gam_indv = lapply(sort(unique(de_clstr_ap$cluster)), function(c){
  print(c)
  tmp = de_clstr_ap[de_clstr_ap$cluster == c, ]
  
  set.seed(01012020)
  fold = groupKFold(tmp$nuts3Code, k = min(10, (length(unique(tmp$nuts3Code)))))
  
  # inTraining <- createDataPartition(tmp$nuts3Code, p = .75, list = FALSE)
  # training <- tmp[ inTraining,]
  # testing  <- tmp[-inTraining,]
  
  # training = training[-which(training$nuts3Code %in% unique(de_clstr[which(is.na(de_clstr$pm25_mean)), "nuts3Code"])),]
  # testing = testing[-which(testing$nuts3Code %in% unique(de_clstr[which(is.na(de_clstr$pm25_mean)), "nuts3Code"])),]
  
  fitControl <- trainControl(index = fold)
  
  set.seed(01042020)
  de_clstr_gam <- train(new_cases_smooth ~ pm25_mean, data = tmp, 
                        method = "gam", family = quasipoisson, 
                        trControl = fitControl,
                        ## This last option is actually one
                        ## for gbm() that passes through
                        verbose = FALSE)
  return(de_clstr_gam)
})

stopCluster(cl)
```

```{r, eval = TRUE, echo=FALSE, message=FALSE, warning=FALSE, results = TRUE}
print(de_clstr_gam_indv)
```


## Geographical overview of the clusters
```{r, eval = TRUE, echo=FALSE, warning=FALSE, message=FALSE}
# mapview(italy$pm_waqi_points$pts, popup = italy$pm_waqi_points$pop, 
#         legend = FALSE, ncol="pm25max")

de_clstr_map = lapply(seq(length(nuts3_mean)), function(c){
  tmp = nuts3_mean[[c]][1, ]
  tmp$cluster = as.factor(paste0("c ", new_cases_dtw_cluster@cluster[c], " n=(", 
                                 new_cases_dtw_cluster@clusinfo[new_cases_dtw_cluster@cluster[c], 1],
                                 ")"))
  return(tmp)
})
de_clstr_map = do.call("rbind", de_clstr_map)

mapview(de_clstr_map, zcol = "cluster")

# mapview(germany$pm_uba_points$pts, popup = germany$pm_uba_points$pop, 
#         legend = FALSE, ncol="pm25max")
```


```{r, eval = TRUE, echo=FALSE, warning=FALSE, message=FALSE}
# Roland

test = de_avg
test$week.day = weekdays(test$date)
test$week.day.c = weekdays(test$date)

# week.day <- weekdays(data[[1]]$date)
# week.day.c <- week.day
for (i in (1:length(test$week.day)))
  test$week.day.c[i] = ifelse((test$week.day[i] == "Montag"), "M",
                                      ifelse((test$week.day[i] == "Sonntag") |
                                               (test$week.day[i] == "Samstag"),
                                             "SS","W"))
test$week.day.c = as.factor(test$week.day.c)
erg.covid = glm(test$new_cases ~ test$date + test$week.day.c, poisson)
summary(erg.covid)


erg.covid.pm <- glm(test$new_cases ~ c(1:47) + test$week.day.c +
                I(test$pm25_mean), quasipoisson)
summary(erg.covid.pm)

library(lme4)
erg.covid.pm <- glmer(test$new_cases ~ c(1:47) + test$week.day.c +
                      I(test$pm25_mean) +
                      (1|as.factor(c(1:47))), family=poisson)
summary(erg.covid.pm)

```